<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>주식 시뮬레이터</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    canvas { max-width: 100%; }
    .stock, .controls { margin-bottom: 20px; }
    input { width: 60px; }
    .ranking { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>📈 주식 시뮬레이터</h2>
  <div>
    사용자 이름: <input id="usernameInput" placeholder="이름 입력" />
    <button onclick="saveUsername()">저장</button>
  </div>
  <div id="welcome"></div>
  <div class="stock">
    <canvas id="stockChart"></canvas>
  </div>
  <div class="controls">
    <p>자금: <span id="money">100000</span>원</p>
    <p>보유 롱: <span id="longHoldings">0</span>주 / 보유 숏: <span id="shortHoldings">0</span>주</p>
    <p>현재 주가: <span id="currentPrice">-</span>원</p>
    <input type="number" id="qty" placeholder="수량" />
    <button onclick="buyStock('long')">롱 매수</button>
    <button onclick="sellStock('long')">롱 매도</button>
    <button onclick="buyStock('short')">숏 매수</button>
    <button onclick="sellStock('short')">숏 매도</button>
  </div>
  <div class="ranking">
    <h3>🏆 수익률 랭킹</h3>
    <ul id="rankingList"></ul>
  </div>

  <script>
    const ctx = document.getElementById('stockChart').getContext('2d');
    let price = 100;
    let prices = Array(30).fill(price);
    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({ length: 30 }, (_, i) => i + 1),
        datasets: [{
          label: '주가',
          data: prices,
          borderColor: 'blue',
          fill: false
        }]
      },
      options: { responsive: true }
    });

    let money = 100000;
    let longHoldings = 0;
    let shortHoldings = 0;
    let averageShortPrice = 0;
    let username = localStorage.getItem("username") || "";

    if (username) document.getElementById("welcome").textContent = `환영합니다, ${username}님!`;

    function updateDisplay() {
      document.getElementById("money").textContent = money.toFixed(0);
      document.getElementById("longHoldings").textContent = longHoldings;
      document.getElementById("shortHoldings").textContent = shortHoldings;
      document.getElementById("currentPrice").textContent = price.toFixed(0);
    }

    function saveUsername() {
      username = document.getElementById("usernameInput").value;
      if (username) {
        localStorage.setItem("username", username);
        document.getElementById("welcome").textContent = `환영합니다, ${username}님!`;
      }
    }

    function buyStock(position) {
      const qty = parseInt(document.getElementById("qty").value);
      if (!qty || qty <= 0) return alert("수량을 입력하세요.");
      const cost = qty * price;
      if (position === "long") {
        if (money >= cost) {
          money -= cost;
          longHoldings += qty;
        } else alert("자금 부족");
      } else if (position === "short") {
        shortHoldings += qty;
        averageShortPrice = ((averageShortPrice * (shortHoldings - qty)) + (price * qty)) / shortHoldings;
        money += cost;
      }
      updateDisplay();
      updateRanking();
    }

    function sellStock(position) {
      const qty = parseInt(document.getElementById("qty").value);
      if (!qty || qty <= 0) return alert("수량을 입력하세요.");
      if (position === "long") {
        if (longHoldings >= qty) {
          longHoldings -= qty;
          money += qty * price;
        } else alert("롱 보유 수량 부족");
      } else if (position === "short") {
        if (shortHoldings >= qty) {
          shortHoldings -= qty;
          const gain = (averageShortPrice - price) * qty;
          money -= price * qty;
          money += gain + price * qty;
        } else alert("숏 보유 수량 부족");
      }
      updateDisplay();
      updateRanking();
    }

    function updatePrice() {
      const change = (Math.random() - 0.5) * 4 + 0.5; // 소폭 상승 경향
      price = Math.max(1, price + change);
      prices.push(price);
      prices.shift();
      chart.data.datasets[0].data = prices;
      chart.update();
      updateDisplay();
      updateRanking();
    }

    function updateRanking() {
      if (!username) return;
      const totalValue = money + longHoldings * price + shortHoldings * (averageShortPrice - price);
      localStorage.setItem(`ranking_${username}`, totalValue);
      displayRanking();
    }

    function displayRanking() {
      let rankingList = [];
      for (let key in localStorage) {
        if (key.startsWith("ranking_")) {
          let name = key.replace("ranking_", "");
          rankingList.push({ name, value: parseFloat(localStorage.getItem(key)) });
        }
      }
      rankingList.sort((a, b) => b.value - a.value);
      const ul = document.getElementById("rankingList");
      ul.innerHTML = "";
      rankingList.forEach((entry, i) => {
        const li = document.createElement("li");
        li.textContent = `${i + 1}. ${entry.name} - 총 자산: ${entry.value.toFixed(0)}원`;
        ul.appendChild(li);
      });
    }

    updateDisplay();
    displayRanking();
    setInterval(updatePrice, 2000);
  </script>
</body>
</html>
