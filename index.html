<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>실시간 주식 거래 시뮬레이터</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
    }
    .sidebar {
      width: 200px;
      background: #f5f5f5;
      padding: 10px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .chart-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .stock-list button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
    }
    .controls {
      margin-top: 10px;
    }
    .info {
      margin-top: 10px;
    }
    .log-table, .log-table th, .log-table td {
      border: 1px solid #ccc;
      border-collapse: collapse;
    }
    .log-table th, .log-table td {
      padding: 5px;
    }
    .rankings {
      margin-top: 20px;
      font-size: 14px;
    }
    .max-buy {
      margin-top: 5px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>종목 선택</h2>
    <div class="stock-list" id="stockButtons"></div>
    <div class="rankings">
      <h3>🏆 수익률 순위</h3>
      <ul id="rankList"></ul>
    </div>
    <div style="margin-top:20px;">
      <label for="userNameInput">사용자 이름:</label><br />
      <input type="text" id="userNameInput" placeholder="이름 입력" />
      <button id="setNameBtn">설정</button>
    </div>
  </div>

  <div class="chart-container">
    <h1 id="stock-title">초기투자</h1>
    <div style="font-size: 18px; margin-bottom: 15px;">
      현재 주가: <span id="currentPrice" style="font-weight: bold;">0</span>원
    </div>
    <div class="controls">
      <input type="number" id="tradeAmount" value="1" min="1" />
      <button onclick="buyStock()">🟢 매수</button>
      <button onclick="sellStock()">🔴 매도</button>
      <div class="max-buy" id="maxBuy"></div>
      <div class="info">
        💰 자금: <span id="cash">-</span>원 |
        💼 보유 수량: <span id="shares">-</span>개<br />
        📈 손익: <span id="profit" style="font-weight: bold;">-</span>
      </div>
    </div>
    <canvas id="stockChart" width="1200" height="400"></canvas>
    <h3>📋 거래 내역</h3>
    <table class="log-table" id="tradeLog">
      <thead>
        <tr>
          <th>시간</th>
          <th>종목</th>
          <th>구분</th>
          <th>단가</th>
          <th>수량</th>
          <th>총액</th>
          <th>손익</th>
          <th>수익률</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const stocks = ['초기투자', '삼성전자', '현대차', 'LG전자', '카카오', '네이버', '셀트리온', 'POSCO', 'SK하이닉스', '기아'];
    const startPrices = {
      '초기투자': 1000, '삼성전자': 60000, '현대차': 220000, 'LG전자': 130000,
      '카카오': 70000, '네이버': 300000, '셀트리온': 250000, 'POSCO': 300000,
      'SK하이닉스': 110000, '기아': 85000
    };
    const maxDataLength = 50;
    const initialCash = 100000;

    let currentUserName = null;
    let usersData = {};
    let currentStock = stocks[0];
    let stockData = {};
    let chart, data;
    let priceUpdateInterval = null;
    let crashCounter = 0;

    function getRandomPrice(prevPrice, isCrash = false) {
      let changePercent;
      if (isCrash) {
        changePercent = -0.3 + Math.random() * 0.1; // -30% ~ -20%
      } else {
        const bias = Math.random();
        if (bias < 0.55) {
          changePercent = 0.001 + Math.random() * 0.007; // 상승 55%
        } else {
          changePercent = -0.001 - Math.random() * 0.006; // 하락 45%
        }
      }
      return Math.max(1, Math.round(prevPrice * (1 + changePercent)));
    }

    function generateInitialData(startPrice) {
      const arr = [startPrice];
      for (let i = 1; i < maxDataLength; i++) {
        arr.push(getRandomPrice(arr[i - 1]));
      }
      return arr;
    }

    function initStockData() {
      stocks.forEach(stock => {
        stockData[stock] = generateInitialData(startPrices[stock]);
      });
    }

    function updateStockPrices() {
      crashCounter++;
      const allCrash = crashCounter >= 30;
      if (allCrash) crashCounter = 0;

      stocks.forEach(stock => {
        let arr = stockData[stock];
        const prevPrice = arr[arr.length - 1];
        const newPrice = getRandomPrice(prevPrice, allCrash);
        arr.push(newPrice);
        if (arr.length > maxDataLength) arr.shift();
      });

      updateChart();
      updateInfo();
      updateRanking();
    }

    // 기존 함수 정의 이어짐...
  </script>
</body>
</html>
