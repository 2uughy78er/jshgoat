<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ ì£¼ì‹ ê±°ë˜ ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
    }
    .sidebar {
      width: 200px;
      background: #f5f5f5;
      padding: 10px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .chart-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .stock-list button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
    }
    .controls {
      margin-top: 10px;
    }
    .info {
      margin-top: 10px;
    }
    .log-table, .log-table th, .log-table td {
      border: 1px solid #ccc;
      border-collapse: collapse;
    }
    .log-table th, .log-table td {
      padding: 5px;
    }
    .rankings {
      margin-top: 20px;
      font-size: 14px;
    }
    .max-buy {
      margin-top: 5px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>ì¢…ëª© ì„ íƒ</h2>
    <div class="stock-list" id="stockButtons"></div>
    <div class="rankings">
      <h3>ğŸ† ìˆ˜ìµë¥  ìˆœìœ„</h3>
      <ul id="rankList"></ul>
    </div>
    <div style="margin-top:20px;">
      <label for="userNameInput">ì‚¬ìš©ì ì´ë¦„:</label><br />
      <input type="text" id="userNameInput" placeholder="ì´ë¦„ ì…ë ¥" />
      <button id="setNameBtn">ì„¤ì •</button>
    </div>
  </div>

  <div class="chart-container">
    <h1 id="stock-title">ì´ˆê¸°íˆ¬ì</h1>
    <div style="font-size: 18px; margin-bottom: 15px;">
      í˜„ì¬ ì£¼ê°€: <span id="currentPrice" style="font-weight: bold;">0</span>ì›
    </div>
    <div class="controls">
      <input type="number" id="tradeAmount" value="1" min="1" />
      <button onclick="buyStock()">ğŸŸ¢ ë§¤ìˆ˜</button>
      <button onclick="sellStock()">ğŸ”´ ë§¤ë„</button>
      <div class="max-buy" id="maxBuy"></div>
      <div class="info">
        ğŸ’° ìê¸ˆ: <span id="cash">-</span>ì› |
        ğŸ’¼ ë³´ìœ  ìˆ˜ëŸ‰: <span id="shares">-</span>ê°œ<br />
        ğŸ“ˆ ì†ìµ: <span id="profit" style="font-weight: bold;">-</span>
      </div>
    </div>
    <canvas id="stockChart" width="1200" height="400"></canvas>
    <h3>ğŸ“‹ ê±°ë˜ ë‚´ì—­</h3>
    <table class="log-table" id="tradeLog">
      <thead>
        <tr>
          <th>ì‹œê°„</th>
          <th>ì¢…ëª©</th>
          <th>êµ¬ë¶„</th>
          <th>ë‹¨ê°€</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ì´ì•¡</th>
          <th>ì†ìµ</th>
          <th>ìˆ˜ìµë¥ </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const stocks = ['ì´ˆê¸°íˆ¬ì', 'ì‚¼ì„±ì „ì', 'í˜„ëŒ€ì°¨', 'LGì „ì', 'ì¹´ì¹´ì˜¤', 'ë„¤ì´ë²„', 'ì…€íŠ¸ë¦¬ì˜¨', 'POSCO', 'SKí•˜ì´ë‹‰ìŠ¤', 'ê¸°ì•„'];
    const startPrices = {
      'ì´ˆê¸°íˆ¬ì': 1000, 'ì‚¼ì„±ì „ì': 60000, 'í˜„ëŒ€ì°¨': 220000, 'LGì „ì': 130000,
      'ì¹´ì¹´ì˜¤': 70000, 'ë„¤ì´ë²„': 300000, 'ì…€íŠ¸ë¦¬ì˜¨': 250000, 'POSCO': 300000,
      'SKí•˜ì´ë‹‰ìŠ¤': 110000, 'ê¸°ì•„': 85000
    };
    const maxDataLength = 50;
    const initialCash = 100000;

    let currentUserName = null;
    let usersData = {};
    let currentStock = stocks[0];
    let stockData = {};
    let chart, data;
    let priceUpdateInterval = null;
    let crashCounter = 0;

    function getRandomPrice(prevPrice, isCrash = false) {
      let changePercent;
      if (isCrash) {
        changePercent = -0.3 + Math.random() * 0.1; // -30% ~ -20%
      } else {
        changePercent = 0.002 + (Math.random() - 0.5) * 0.01; // ì†Œí­ ìƒìŠ¹ í¸í–¥
      }
      return Math.max(1, Math.round(prevPrice * (1 + changePercent)));
    }

    function generateInitialData(startPrice) {
      const arr = [startPrice];
      for (let i = 1; i < maxDataLength; i++) {
        arr.push(getRandomPrice(arr[i - 1]));
      }
      return arr;
    }

    function initStockData() {
      stocks.forEach(stock => {
        stockData[stock] = generateInitialData(startPrices[stock]);
      });
    }

    function updateStockPrices() {
      crashCounter++;
      let crashIndex = -1;
      if (crashCounter >= 30) {
        crashIndex = Math.floor(Math.random() * stocks.length);
        crashCounter = 0;
      }

      stocks.forEach((stock, i) => {
        let arr = stockData[stock];
        const prevPrice = arr[arr.length - 1];
        const newPrice = getRandomPrice(prevPrice, i === crashIndex);
        arr.push(newPrice);
        if (arr.length > maxDataLength) arr.shift();
      });

      updateChart();
      updateInfo();
      updateRanking();
    }

    function loadUsersData() {
      const saved = localStorage.getItem('stockSimData');
      usersData = saved ? JSON.parse(saved) : {};
    }

    function saveUsersData() {
      localStorage.setItem('stockSimData', JSON.stringify(usersData));
    }

    function initCurrentUser(name) {
      currentUserName = name;
      localStorage.setItem('currentUserName', name);
      if (!usersData[name]) {
        usersData[name] = { cash: initialCash, stocks: {}, trades: [] };
      }
      saveUsersData();
      updateInfo();
      updateTradeLog();
      updateRanking();
    }

    function buyStock() {
      const amount = parseInt(document.getElementById('tradeAmount').value);
      if (isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ ì˜¤ë¥˜");
      const price = stockData[currentStock].slice(-1)[0];
      const totalCost = price * amount;
      if (usersData[currentUserName].cash < totalCost) return alert("ìê¸ˆ ë¶€ì¡±");

      usersData[currentUserName].cash -= totalCost;
      usersData[currentUserName].stocks[currentStock] = (usersData[currentUserName].stocks[currentStock] || 0) + amount;
      usersData[currentUserName].trades.push({ time: new Date().toLocaleTimeString(), stock: currentStock, type: "ë§¤ìˆ˜", price, amount, total: totalCost });
      saveUsersData();
      updateInfo();
      updateTradeLog();
    }

    function sellStock() {
      const amount = parseInt(document.getElementById('tradeAmount').value);
      if (isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ ì˜¤ë¥˜");
      const price = stockData[currentStock].slice(-1)[0];
      const held = usersData[currentUserName].stocks[currentStock] || 0;
      if (held < amount) return alert("ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡±");

      usersData[currentUserName].stocks[currentStock] -= amount;
      const gain = price * amount;
      usersData[currentUserName].cash += gain;
      usersData[currentUserName].trades.push({ time: new Date().toLocaleTimeString(), stock: currentStock, type: "ë§¤ë„", price, amount, total: gain });
      saveUsersData();
      updateInfo();
      updateTradeLog();
    }

    function updateTradeLog() {
      const logBody = document.getElementById('tradeLog').querySelector('tbody');
      logBody.innerHTML = "";
      usersData[currentUserName].trades.slice().reverse().forEach(trade => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${trade.time}</td>
          <td>${trade.stock}</td>
          <td>${trade.type}</td>
          <td>${trade.price}</td>
          <td>${trade.amount}</td>
          <td>${trade.total}</td>
          <td>-</td>
          <td>-</td>
        `;
        logBody.appendChild(row);
      });
    }

    function updateInfo() {
      document.getElementById('cash').textContent = usersData[currentUserName].cash.toLocaleString();
      const price = stockData[currentStock].slice(-1)[0];
      const shares = usersData[currentUserName].stocks[currentStock] || 0;
      document.getElementById('shares').textContent = shares;
      document.getElementById('currentPrice').textContent = price.toLocaleString();
      document.getElementById('maxBuy').textContent = `ìµœëŒ€ ë§¤ìˆ˜ ê°€ëŠ¥: ${Math.floor(usersData[currentUserName].cash / price)}ì£¼`;
      document.getElementById('profit').textContent = '-'; // ë‹¨ìˆœ í‘œì‹œ
    }

    function calculateUserReturn(user) {
      let totalValue = user.cash;
      for (const stock in user.stocks) {
        const amount = user.stocks[stock];
        const latestPrice = stockData[stock]?.slice(-1)[0] || 0;
        totalValue += amount * latestPrice;
      }
      return ((totalValue - initialCash) / initialCash) * 100;
    }

    function updateRanking() {
      const rankList = document.getElementById('rankList');
      const ranked = Object.entries(usersData)
        .map(([name, user]) => ({ name, return: calculateUserReturn(user) }))
        .sort((a, b) => b.return - a.return);
      rankList.innerHTML = ranked.map(r => `<li>${r.name}: ${r.return.toFixed(2)}%</li>`).join("");
    }

    function createStockButtons() {
      const container = document.getElementById('stockButtons');
      container.innerHTML = "";
      stocks.forEach(stock => {
        const btn = document.createElement('button');
        btn.textContent = stock;
        btn.onclick = () => selectStock(stock);
        container.appendChild(btn);
      });
    }

    function initChart() {
      const ctx = document.getElementById('stockChart').getContext('2d');
      data = {
        labels: Array(maxDataLength).fill(""),
        datasets: [{
          label: "ê°€ê²©",
          data: stockData[currentStock],
          borderColor: 'blue',
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }]
      };
      chart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: { animation: false }
      });
    }

    function updateChart() {
      data.datasets[0].data = stockData[currentStock];
      chart.update();
    }

    function selectStock(stock) {
      currentStock = stock;
      document.getElementById('stock-title').textContent = stock;
      updateChart();
      updateInfo();
    }

    document.getElementById('setNameBtn').onclick = () => {
      const name = document.getElementById('userNameInput').value.trim();
      if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      initCurrentUser(name);
      if (priceUpdateInterval) clearInterval(priceUpdateInterval);
      priceUpdateInterval = setInterval(updateStockPrices, 1000);
    };

    function init() {
      initStockData();
      loadUsersData();
      const savedName = localStorage.getItem('currentUserName');
      if (savedName && savedName in usersData) {
        currentUserName = savedName;
        document.getElementById('userNameInput').value = currentUserName;
        initCurrentUser(currentUserName);
      }
      createStockButtons();
      selectStock(currentStock);
      initChart();
      priceUpdateInterval = setInterval(updateStockPrices, 1000);
    }

    init();
  </script>
</body>
</html>
