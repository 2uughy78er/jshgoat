<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>주식 시뮬레이터 (롱/숏)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    canvas { max-width: 800px; margin: 20px auto; display: block; }
    .info, .controls { max-width: 800px; margin: auto; }
    .controls input, .controls button { margin: 5px; }
    .status { margin-top: 10px; }
  </style>
</head>
<body>

<h2>📈 주식 시뮬레이터 (롱/숏 포함)</h2>

<canvas id="stockChart" width="800" height="400"></canvas>

<div class="controls">
  <label>금액: <input type="number" id="amount" value="10000"></label>
  <button onclick="buyStock()">매수 (롱)</button>
  <button onclick="sellStock()">매도 (롱)</button>
  <button onclick="shortStock()">숏 진입</button>
  <button onclick="coverShort()">숏 청산</button>
  <button onclick="triggerCrash()">📉 전체 폭락</button>
</div>

<div class="info">
  <p class="status" id="price">현재 가격: </p>
  <p class="status" id="cash">보유 현금: </p>
  <p class="status" id="stocks">보유 주식 수: </p>
  <p class="status" id="shorts">숏 포지션 수: </p>
  <p class="status" id="total">총 자산: </p>
</div>

<script>
let prices = [100];
let cash = parseFloat(localStorage.getItem('cash')) || 100000;
let stocks = parseInt(localStorage.getItem('stocks')) || 0;
let shortPosition = parseInt(localStorage.getItem('shortPosition')) || 0;
let shortPrice = parseFloat(localStorage.getItem('shortPrice')) || 0;

const ctx = document.getElementById('stockChart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array.from({length: prices.length}, (_, i) => i),
    datasets: [{
      label: '주가',
      data: prices,
      borderColor: 'blue',
      borderWidth: 2,
      fill: false
    }]
  },
  options: {
    scales: {
      y: { beginAtZero: false }
    }
  }
});

function updateDisplay() {
  const latestPrice = prices[prices.length - 1];
  const totalValue = cash + (stocks * latestPrice) + (shortPosition * (shortPrice - latestPrice));
  document.getElementById("price").innerText = `현재 가격: ${latestPrice.toFixed(2)}원`;
  document.getElementById("cash").innerText = `보유 현금: ${cash.toFixed(2)}원`;
  document.getElementById("stocks").innerText = `보유 주식 수: ${stocks}`;
  document.getElementById("shorts").innerText = `숏 포지션 수: ${shortPosition} (진입가: ${shortPrice || 0}원)`;
  document.getElementById("total").innerText = `총 자산: ${totalValue.toFixed(2)}원`;

  // 저장
  localStorage.setItem("cash", cash);
  localStorage.setItem("stocks", stocks);
  localStorage.setItem("shortPosition", shortPosition);
  localStorage.setItem("shortPrice", shortPrice);
}

function nextPrice() {
  const last = prices[prices.length - 1];
  const random = Math.random() * 10 - 5; // 상승/하락 포함
  const trend = 0.5;
  const next = Math.max(1, last + random + trend);
  prices.push(next);
  chart.data.labels.push(prices.length - 1);
  chart.data.datasets[0].data = prices;
  chart.update();
  updateDisplay();
}

function buyStock() {
  const amount = parseFloat(document.getElementById("amount").value);
  const price = prices[prices.length - 1];
  const shares = Math.floor(amount / price);
  if (shares > 0 && price * shares <= cash) {
    stocks += shares;
    cash -= shares * price;
    updateDisplay();
  }
}

function sellStock() {
  const price = prices[prices.length - 1];
  const amount = parseFloat(document.getElementById("amount").value);
  const shares = Math.min(Math.floor(amount / price), stocks);
  if (shares > 0) {
    stocks -= shares;
    cash += shares * price;
    updateDisplay();
  }
}

function shortStock() {
  const price = prices[prices.length - 1];
  const amount = parseFloat(document.getElementById("amount").value);
  const shares = Math.floor(amount / price);
  if (shares > 0 && price * shares <= cash) {
    shortPosition += shares;
    shortPrice = ((shortPrice * (shortPosition - shares)) + (price * shares)) / shortPosition;
    cash += price * shares;
    updateDisplay();
  }
}

function coverShort() {
  const price = prices[prices.length - 1];
  const amount = parseFloat(document.getElementById("amount").value);
  const shares = Math.min(Math.floor(amount / price), shortPosition);
  if (shares > 0) {
    shortPosition -= shares;
    cash -= shares * price;
    cash += shares * (shortPrice - price); // 이익 반영
    if (shortPosition === 0) shortPrice = 0;
    updateDisplay();
  }
}

function triggerCrash() {
  const crashAmount = 20;
  const current = prices[prices.length - 1];
  prices.push(Math.max(1, current - crashAmount));
  chart.data.labels.push(prices.length - 1);
  chart.data.datasets[0].data = prices;
  chart.update();
  updateDisplay();
}

// 주가 실시간 변동
setInterval(nextPrice, 3000);
updateDisplay();
</script>

</body>
</html>
