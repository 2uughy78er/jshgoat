<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì£¼ì‹ ì‹œë®¬ë ˆì´í„° (ë¡±/ìˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    canvas { max-width: 800px; margin: 20px auto; display: block; }
    .info, .controls { max-width: 800px; margin: auto; }
    .controls input, .controls button { margin: 5px; }
    .status { margin-top: 10px; }
  </style>
</head>
<body>

<h2>ğŸ“ˆ ì£¼ì‹ ì‹œë®¬ë ˆì´í„° (ë¡±/ìˆ í¬í•¨)</h2>

<canvas id="stockChart" width="800" height="400"></canvas>

<div class="controls">
  <label>ê¸ˆì•¡: <input type="number" id="amount" value="10000"></label>
  <button onclick="buyStock()">ë§¤ìˆ˜ (ë¡±)</button>
  <button onclick="sellStock()">ë§¤ë„ (ë¡±)</button>
  <button onclick="shortStock()">ìˆ ì§„ì…</button>
  <button onclick="coverShort()">ìˆ ì²­ì‚°</button>
  <button onclick="triggerCrash()">ğŸ“‰ ì „ì²´ í­ë½</button>
</div>

<div class="info">
  <p class="status" id="price">í˜„ì¬ ê°€ê²©: </p>
  <p class="status" id="cash">ë³´ìœ  í˜„ê¸ˆ: </p>
  <p class="status" id="stocks">ë³´ìœ  ì£¼ì‹ ìˆ˜: </p>
  <p class="status" id="shorts">ìˆ í¬ì§€ì…˜ ìˆ˜: </p>
  <p class="status" id="total">ì´ ìì‚°: </p>
</div>

<script>
let prices = [100];
let cash = parseFloat(localStorage.getItem('cash')) || 100000;
let stocks = parseInt(localStorage.getItem('stocks')) || 0;
let shortPosition = parseInt(localStorage.getItem('shortPosition')) || 0;
let shortPrice = parseFloat(localStorage.getItem('shortPrice')) || 0;

const ctx = document.getElementById('stockChart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array.from({length: prices.length}, (_, i) => i),
    datasets: [{
      label: 'ì£¼ê°€',
      data: prices,
      borderColor: 'blue',
      borderWidth: 2,
      fill: false
    }]
  },
  options: {
    scales: {
      y: { beginAtZero: false }
    }
  }
});

function updateDisplay() {
  const latestPrice = prices[prices.length - 1];
  const totalValue = cash + (stocks * latestPrice) + (shortPosition * (shortPrice - latestPrice));
  document.getElementById("price").innerText = `í˜„ì¬ ê°€ê²©: ${latestPrice.toFixed(2)}ì›`;
  document.getElementById("cash").innerText = `ë³´ìœ  í˜„ê¸ˆ: ${cash.toFixed(2)}ì›`;
  document.getElementById("stocks").innerText = `ë³´ìœ  ì£¼ì‹ ìˆ˜: ${stocks}`;
  document.getElementById("shorts").innerText = `ìˆ í¬ì§€ì…˜ ìˆ˜: ${shortPosition} (ì§„ì…ê°€: ${shortPrice || 0}ì›)`;
  document.getElementById("total").innerText = `ì´ ìì‚°: ${totalValue.toFixed(2)}ì›`;

  // ì €ì¥
  localStorage.setItem("cash", cash);
  localStorage.setItem("stocks", stocks);
  localStorage.setItem("shortPosition", shortPosition);
  localStorage.setItem("shortPrice", shortPrice);
}

function nextPrice() {
  const last = prices[prices.length - 1];
  const random = Math.random() * 10 - 5; // ìƒìŠ¹/í•˜ë½ í¬í•¨
  const trend = 0.5;
  const next = Math.max(1, last + random + trend);
  prices.push(next);
  chart.data.labels.push(prices.length - 1);
  chart.data.datasets[0].data = prices;
  chart.update();
  updateDisplay();
}

function buyStock() {
  const amount = parseFloat(document.getElementById("amount").value);
  const price = prices[prices.length - 1];
  const shares = Math.floor(amount / price);
  if (shares > 0 && price * shares <= cash) {
    stocks += shares;
    cash -= shares * price;
    updateDisplay();
  }
}

function sellStock() {
  const price = prices[prices.length - 1];
  const amount = parseFloat(document.getElementById("amount").value);
  const shares = Math.min(Math.floor(amount / price), stocks);
  if (shares > 0) {
    stocks -= shares;
    cash += shares * price;
    updateDisplay();
  }
}

function shortStock() {
  const price = prices[prices.length - 1];
  const amount = parseFloat(document.getElementById("amount").value);
  const shares = Math.floor(amount / price);
  if (shares > 0 && price * shares <= cash) {
    shortPosition += shares;
    shortPrice = ((shortPrice * (shortPosition - shares)) + (price * shares)) / shortPosition;
    cash += price * shares;
    updateDisplay();
  }
}

function coverShort() {
  const price = prices[prices.length - 1];
  const amount = parseFloat(document.getElementById("amount").value);
  const shares = Math.min(Math.floor(amount / price), shortPosition);
  if (shares > 0) {
    shortPosition -= shares;
    cash -= shares * price;
    cash += shares * (shortPrice - price); // ì´ìµ ë°˜ì˜
    if (shortPosition === 0) shortPrice = 0;
    updateDisplay();
  }
}

function triggerCrash() {
  const crashAmount = 20;
  const current = prices[prices.length - 1];
  prices.push(Math.max(1, current - crashAmount));
  chart.data.labels.push(prices.length - 1);
  chart.data.datasets[0].data = prices;
  chart.update();
  updateDisplay();
}

// ì£¼ê°€ ì‹¤ì‹œê°„ ë³€ë™
setInterval(nextPrice, 3000);
updateDisplay();
</script>

</body>
</html>
