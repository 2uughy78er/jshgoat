<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì£¼ì‹ ì‹œë®¬ë ˆì´í„° (ë¡±/ìˆ + í­ë“±/í­ë½ + ì°¨íŠ¸)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    display: flex;
    font-family: Arial, sans-serif;
    margin: 0; height: 100vh;
    overflow: hidden;
  }
  .sidebar {
    width: 220px;
    background: #f0f0f0;
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  .sidebar h2 {
    margin-top: 0;
  }
  #stockButtons button {
    width: 100%;
    margin-bottom: 5px;
    padding: 5px;
    cursor: pointer;
  }
  .chart-container {
    flex-grow: 1;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #tradeAmount {
    width: 80px;
  }
  .info {
    margin-top: 10px;
  }
  .log-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 14px;
  }
  .log-table th, .log-table td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    text-align: center;
  }
  .rankings ul {
    padding-left: 20px;
  }
</style>
</head>
<body>
<div class="sidebar">
  <h2>ì¢…ëª© ì„ íƒ</h2>
  <div id="stockButtons"></div>
  <div class="rankings">
    <h3>ğŸ† ìˆ˜ìµë¥  ìˆœìœ„</h3>
    <ul id="rankList"></ul>
  </div>
  <div style="margin-top:20px;">
    <label for="userNameInput">ì‚¬ìš©ì ì´ë¦„:</label><br />
    <input type="text" id="userNameInput" placeholder="ì´ë¦„ ì…ë ¥" />
    <button id="setNameBtn">ì„¤ì •</button>
  </div>
</div>

<div class="chart-container">
  <h1 id="stock-title">ì´ˆê¸°íˆ¬ì</h1>
  <div style="font-size:18px; margin-bottom:10px;">
    í˜„ì¬ ì£¼ê°€: <span id="currentPrice">-</span>ì›
  </div>
  <div>
    <input type="number" id="tradeAmount" value="1" min="1" /> ê°œ
    <button onclick="buyStock()">ğŸŸ¢ ë¡± ë§¤ìˆ˜</button>
    <button onclick="sellStock()">ğŸ”´ ë¡± ë§¤ë„</button><br /><br />
    <button onclick="shortSell()">ğŸ“‰ ìˆ ë§¤ìˆ˜ (ìˆ ì§„ì…)</button>
    <button onclick="shortBuy()">ğŸ“ˆ ìˆ ë§¤ë„ (ìˆ ì²­ì‚°)</button>
  </div>
  <div class="info">
    ğŸ’° ìê¸ˆ: <span id="cash">-</span>ì›<br />
    ğŸ’¼ ë³´ìœ  ì£¼ì‹: <span id="shares">-</span>ê°œ<br />
    ğŸŸ  ìˆ í¬ì§€ì…˜: <span id="shortShares">-</span>ê°œ
  </div>
  <canvas id="stockChart" width="900" height="400" style="margin-top:15px;"></canvas>

  <h3>ğŸ“‹ ê±°ë˜ ë‚´ì—­</h3>
  <table class="log-table">
    <thead>
      <tr><th>ì‹œê°„</th><th>ì¢…ëª©</th><th>êµ¬ë¶„</th><th>ë‹¨ê°€</th><th>ìˆ˜ëŸ‰</th><th>ì´ì•¡</th></tr>
    </thead>
    <tbody id="tradeLogBody"></tbody>
  </table>
</div>

<script>
  // ====== ê¸°ë³¸ ë°ì´í„° ì„¸íŒ… ======
  const stocks = ['ì´ˆê¸°íˆ¬ì', 'ì‚¼ì„±ì „ì', 'í˜„ëŒ€ì°¨', 'LGì „ì', 'ì¹´ì¹´ì˜¤', 'ë„¤ì´ë²„', 'ì…€íŠ¸ë¦¬ì˜¨', 'POSCO', 'SKí•˜ì´ë‹‰ìŠ¤', 'ê¸°ì•„'];
  const startPrices = {
    'ì´ˆê¸°íˆ¬ì': 1000, 'ì‚¼ì„±ì „ì': 60000, 'í˜„ëŒ€ì°¨': 220000, 'LGì „ì': 130000,
    'ì¹´ì¹´ì˜¤': 70000, 'ë„¤ì´ë²„': 300000, 'ì…€íŠ¸ë¦¬ì˜¨': 250000, 'POSCO': 300000,
    'SKí•˜ì´ë‹‰ìŠ¤': 110000, 'ê¸°ì•„': 85000
  };
  const initialCash = 100000;
  const maxDataLength = 50;

  let usersData = {}; // { ì‚¬ìš©ìëª…: { cash, stocks, shortStocks, trades } }
  let currentUserName = null;

  let stockData = {}; // ì¢…ëª©ë³„ ì£¼ê°€ ë°°ì—´
  let currentStock = stocks[0];

  let chart = null;
  let secondsPassed = 0;

  // ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸°
  function loadUsersData() {
    const saved = localStorage.getItem('stockSimData');
    usersData = saved ? JSON.parse(saved) : {};
  }
  function saveUsersData() {
    localStorage.setItem('stockSimData', JSON.stringify(usersData));
  }
  function saveCurrentUser() {
    if(currentUserName) localStorage.setItem('currentUserName', currentUserName);
  }
  function loadCurrentUser() {
    const savedName = localStorage.getItem('currentUserName');
    if(savedName) {
      currentUserName = savedName;
      if(!usersData[currentUserName]) createNewUser(currentUserName);
      document.getElementById('userNameInput').value = currentUserName;
      updateInfo();
      updateTradeLog();
      updateRanking();
    }
  }
  function createNewUser(name) {
    usersData[name] = {
      cash: initialCash,
      stocks: {},
      shortStocks: {},
      trades: []
    };
    saveUsersData();
  }

  function generateInitialData(basePrice) {
    let arr = [basePrice];
    for(let i=1; i<maxDataLength; i++){
      arr.push(Math.max(1, Math.round(arr[i-1] * (1 + (Math.random()-0.5)*0.01))));
    }
    return arr;
  }

  function initStockData(){
    stocks.forEach(stock => {
      stockData[stock] = generateInitialData(startPrices[stock]);
    });
  }

  function createStockButtons(){
    const container = document.getElementById('stockButtons');
    container.innerHTML = '';
    stocks.forEach(stock => {
      const btn = document.createElement('button');
      btn.textContent = stock;
      btn.onclick = () => {
        currentStock = stock;
        document.getElementById('stock-title').textContent = currentStock;
        updateChart();
        updateInfo();
      };
      container.appendChild(btn);
    });
  }

  // ì£¼ê°€ ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤ í­ë½, 45ì´ˆë§ˆë‹¤ í­ë“±, ê·¸ ì™¸ëŠ” ì†Œí­ ë³€ë™)
  function updateStockPrices() {
    secondsPassed++;

    const isCrash = (secondsPassed % 30 === 0);
    const isBoom = (secondsPassed % 45 === 0);

    stocks.forEach(stock => {
      let prevPrice = stockData[stock][stockData[stock].length - 1];
      let newPrice;

      if(isCrash) {
        // 10%~0% í•˜ë½ (í­ë½)
        newPrice = Math.max(1, Math.round(prevPrice * (0.9 + Math.random() * 0.1)));
      }
      else if(isBoom) {
        // 120% ì´ìƒ ìƒìŠ¹ (2.2ë°°)
        newPrice = Math.round(prevPrice * 2.2);
      }
      else {
        // Â±0.5% ë³€ë™ (ì†Œí­ ìƒìŠ¹/í•˜ë½)
        newPrice = Math.max(1, Math.round(prevPrice * (1 + (Math.random() - 0.5) * 0.01)));
      }

      stockData[stock].push(newPrice);
      if(stockData[stock].length > maxDataLength){
        stockData[stock].shift();
      }
    });

    updateChart();
    updateInfo();
    updateRanking();
  }

  function updateChart() {
    const prices = stockData[currentStock];
    const labels = prices.map((_,i) => i + 1);

    if(!chart){
      const ctx = document.getElementById('stockChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: currentStock,
            data: prices,
            borderColor: 'blue',
            backgroundColor: 'rgba(0,0,255,0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 0,
          }]
        },
        options: {
          animation: false,
          responsive: true,
          scales: {
            y: {
              beginAtZero: false
            }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].label = currentStock;
      chart.data.datasets[0].data = prices;
      chart.update();
    }

    document.getElementById('currentPrice').textContent = prices[prices.length - 1].toLocaleString();
  }

  // ë¡± ë§¤ìˆ˜
  function buyStock() {
    if(!currentUserName) return alert("ì‚¬ìš©ì ì´ë¦„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!");
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if(isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
    const price = stockData[currentStock][stockData[currentStock].length - 1];
    const totalCost = price * amount;

    if(usersData[currentUserName].cash < totalCost) return alert("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

    usersData[currentUserName].cash -= totalCost;
    usersData[currentUserName].stocks[currentStock] = (usersData[currentUserName].stocks[currentStock] || 0) + amount;

    logTrade(currentStock, "ë¡± ë§¤ìˆ˜", price, amount, totalCost);
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  // ë¡± ë§¤ë„
  function sellStock() {
    if(!currentUserName) return alert("ì‚¬ìš©ì ì´ë¦„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!");
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if(isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
    const price = stockData[currentStock][stockData[currentStock].length - 1];
    const held = usersData[currentUserName].stocks[currentStock] || 0;

    if(held < amount) return alert("ë³´ìœ  ì£¼ì‹ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

    usersData[currentUserName].stocks[currentStock] -= amount;
    usersData[currentUserName].cash += price * amount;

    logTrade(currentStock, "ë¡± ë§¤ë„", price, amount, price * amount);
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  // ìˆ ë§¤ìˆ˜ (ìˆ ì§„ì…)
  function shortSell() {
    if(!currentUserName) return alert("ì‚¬ìš©ì ì´ë¦„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!");
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if(isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
    const price = stockData[currentStock][stockData[currentStock].length - 1];
    const totalGain = price * amount;

    usersData[currentUserName].cash += totalGain;
    usersData[currentUserName].shortStocks[currentStock] = (usersData[currentUserName].shortStocks[currentStock] || 0) + amount;

    logTrade(currentStock, "ìˆ ë§¤ìˆ˜ (ìˆ ì§„ì…)", price, amount, totalGain);
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  // ìˆ ë§¤ë„ (ìˆ ì²­ì‚°)
  function shortBuy() {
    if(!currentUserName) return alert("ì‚¬ìš©ì ì´ë¦„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!");
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if(isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
    const price = stockData[currentStock][stockData[currentStock].length - 1];
    const heldShort = usersData[currentUserName].shortStocks[currentStock] || 0;

    if(heldShort < amount) return alert("ìˆ í¬ì§€ì…˜ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    const totalCost = price * amount;
    if(usersData[currentUserName].cash < totalCost) return alert("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

    usersData[currentUserName].cash -= totalCost;
    usersData[currentUserName].shortStocks[currentStock] -= amount;

    logTrade(currentStock, "ìˆ ë§¤ë„ (ìˆ ì²­ì‚°)", price, amount, totalCost);
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  // ê±°ë˜ ë‚´ì—­ ê¸°ë¡
  function logTrade(stock, type, price, amount, total) {
    const time = new Date().toLocaleTimeString();
    usersData[currentUserName].trades.push({ time, stock, type, price, amount, total });
    if(usersData[currentUserName].trades.length > 100) {
      usersData[currentUserName].trades.shift();
    }
  }

  function updateTradeLog() {
    const tbody = document.getElementById('tradeLogBody');
    tbody.innerHTML = '';
    const trades = usersData[currentUserName]?.trades || [];
    trades.slice().reverse().forEach(trade => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${trade.time}</td>
        <td>${trade.stock}</td>
        <td>${trade.type}</td>
        <td>${trade.price.toLocaleString()}</td>
        <td>${trade.amount}</td>
        <td>${trade.total.toLocaleString()}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
  function updateInfo() {
    if (!currentUserName) return;
    const user = usersData[currentUserName];
    document.getElementById('cash').textContent = user.cash.toLocaleString();
    document.getElementById('shares').textContent = user.stocks[currentStock] || 0;
    document.getElementById('shortShares').textContent = user.shortStocks[currentStock] || 0;
  }

  // ìˆ˜ìµë¥  ê³„ì‚°
  function calculateProfitRate(user) {
    let assets = user.cash;
    for (const stock in user.stocks) {
      const amount = user.stocks[stock];
      const price = stockData[stock]?.[stockData[stock].length - 1] || 0;
      assets += amount * price;
    }
    for (const stock in user.shortStocks) {
      const amount = user.shortStocks[stock];
      const price = stockData[stock]?.[stockData[stock].length - 1] || 0;
      assets -= amount * price;
    }
    return ((assets - initialCash) / initialCash) * 100;
  }

  // ìˆœìœ„ ì—…ë°ì´íŠ¸
  function updateRanking() {
    const ranking = [];
    for (const name in usersData) {
      const profit = calculateProfitRate(usersData[name]);
      ranking.push({ name, profit });
    }
    ranking.sort((a, b) => b.profit - a.profit);
    const ul = document.getElementById('rankList');
    ul.innerHTML = '';
    ranking.forEach((user, index) => {
      const li = document.createElement('li');
      li.textContent = `${index + 1}. ${user.name}: ${user.profit.toFixed(2)}%`;
      ul.appendChild(li);
    });
  }

  // ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
  document.getElementById('setNameBtn').onclick = () => {
    const name = document.getElementById('userNameInput').value.trim();
    if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    currentUserName = name;
    if (!usersData[currentUserName]) {
      createNewUser(currentUserName);
    }
    saveCurrentUser();
    updateInfo();
    updateTradeLog();
    updateRanking();
  };

  // ====== ì´ˆê¸°í™” ======
  loadUsersData();
  initStockData();
  createStockButtons();
  loadCurrentUser();
  updateChart();
  setInterval(updateStockPrices, 1000); // 1ì´ˆë§ˆë‹¤ ì£¼ê°€ ì—…ë°ì´íŠ¸
</script>
</body>
</html>
