<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #stock-buttons button { margin: 5px; }
    #stock-info, #ranking { margin-top: 20px; }
    #holdings { margin-top: 20px; }
  </style>
</head>
<body>

<h1>ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div>
  ì‚¬ìš©ì ì´ë¦„: <input type="text" id="username" />
  <button onclick="setUserName()">ì„¤ì •</button>
</div>

<div id="stock-buttons"></div>

<div id="stock-info"></div>

<div id="holdings">
  <h3>ë³´ìœ  ì£¼ì‹</h3>
  <div id="holdings-list"></div>
</div>

<canvas id="stock-chart" width="800" height="400"></canvas>

<div id="ranking">
  <h3>ìˆ˜ìµë¥  ë­í‚¹</h3>
  <div id="ranking-list"></div>
</div>

<script>
const stocks = [
  "ì‚¼ì„±ì „ì", "SKí•˜ì´ë‹‰ìŠ¤", "ë„¤ì´ë²„", "ì¹´ì¹´ì˜¤", "LGì „ì", "í˜„ëŒ€ìë™ì°¨", "ê¸°ì•„", "ì…€íŠ¸ë¦¬ì˜¨",
  "NHN", "í•œí™”ì†”ë£¨ì…˜", "POSCO", "CJëŒ€í•œí†µìš´", "ì¹´ì¹´ì˜¤ë±…í¬", "ì•„ëª¨ë ˆí¼ì‹œí”½", "ì €ê°€ì£¼" // ì €ê°€ì£¼ ì²œì›ëŒ€ ì¶”ê°€
];

const seedMoney = 100000; // ì´ˆê¸° ìê¸ˆ 10ë§Œì›

let stockData = {};
let currentStock = stocks[0];
let users = {};
let currentUserName = "";
let priceUpdateInterval;
let chart;
let chartDatasets = [];

function initStockData() {
  stocks.forEach(stock => {
    stockData[stock] = [];
    let startPrice = stock === "ì €ê°€ì£¼" ? 1000 : Math.floor(Math.random() * 90000 + 10000);
    for (let i = 0; i < 50; i++) {
      stockData[stock].push(startPrice);
    }
  });
}

function createStockButtons() {
  const container = document.getElementById("stock-buttons");
  container.innerHTML = "";
  stocks.forEach(stock => {
    const btn = document.createElement("button");
    btn.textContent = stock;
    btn.onclick = () => selectStock(stock);
    container.appendChild(btn);
  });
}

function selectStock(stock) {
  currentStock = stock;
  updateInfo();
  updateChart();
}

function updateStockPrices() {
  stocks.forEach(stock => {
    let arr = stockData[stock];
    arr.shift();

    // ê¸°ë³¸ ë³€ë™: ì•½ê°„ ìƒìŠ¹ ê¸°ì¡°, ì†Œí­ í•˜ë½ ê°€ëŠ¥ì„± í¬í•¨
    let lastPrice = arr[arr.length - 1];
    let changePercent = (Math.random() - 0.4) * 0.03; // -1.2% ~ +1.8% ì •ë„ ë³€ë™, ìƒìŠ¹ì´ ë” í¼
    let newPrice = Math.max(1, Math.floor(lastPrice * (1 + changePercent)));
    arr.push(newPrice);
  });
  updateChart();
  updateInfo();
  updateRanking();
}

function updateInfo() {
  const info = document.getElementById("stock-info");
  const price = stockData[currentStock][stockData[currentStock].length - 1];
  const holdings = users[currentUserName]?.holdings || {};
  const amount = holdings[currentStock] || 0;
  info.innerHTML = `
    <h2>${currentStock}</h2>
    <p>í˜„ì¬ê°€: ${price.toLocaleString()} ì›</p>
    <p>ë³´ìœ ëŸ‰: ${amount} ì£¼</p>
    <button onclick="buyStock()">ë§¤ìˆ˜</button>
    <button onclick="sellStock()">ë§¤ë„</button>
  `;

  updateHoldings();
}

function buyStock() {
  if (!currentUserName) {
    alert("ë¨¼ì € ì‚¬ìš©ì ì´ë¦„ì„ ì„¤ì •í•˜ì„¸ìš”.");
    return;
  }
  const price = stockData[currentStock][stockData[currentStock].length - 1];
  const user = users[currentUserName];
  if (user.money < price) {
    alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    return;
  }
  user.money -= price;
  user.holdings[currentStock] = (user.holdings[currentStock] || 0) + 1;
  saveUsersData();
  updateInfo();
  updateRanking();
}

function sellStock() {
  if (!currentUserName) {
    alert("ë¨¼ì € ì‚¬ìš©ì ì´ë¦„ì„ ì„¤ì •í•˜ì„¸ìš”.");
    return;
  }
  const user = users[currentUserName];
  if ((user.holdings[currentStock] || 0) < 1) {
    alert("ë³´ìœ  ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  const price = stockData[currentStock][stockData[currentStock].length - 1];
  user.holdings[currentStock] -= 1;
  user.money += price;
  if (user.holdings[currentStock] === 0) {
    delete user.holdings[currentStock];
  }
  saveUsersData();
  updateInfo();
  updateRanking();
}

function updateHoldings() {
  const container = document.getElementById("holdings-list");
  container.innerHTML = "";
  if (!currentUserName) {
    container.textContent = "ì‚¬ìš©ì ì´ë¦„ì„ ì„¤ì •í•˜ì„¸ìš”.";
    return;
  }
  const holdings = users[currentUserName]?.holdings || {};
  for (const stock of stocks) {
    if ((holdings[stock] || 0) > 0) {
      const div = document.createElement("div");
      div.textContent = `${stock}: ${holdings[stock]} ì£¼`;
      container.appendChild(div);
    }
  }
}

function updateRanking() {
  const container = document.getElementById("ranking-list");
  container.innerHTML = "";
  // ìˆ˜ìµë¥  ê³„ì‚°: (í˜„ì¬ìì‚° / ì´ˆê¸°ìê¸ˆ) - 1
  let rankingArr = [];
  for (const name in users) {
    const user = users[name];
    let totalAsset = user.money;
    for (const stock in user.holdings) {
      const price = stockData[stock][stockData[stock].length - 1];
      totalAsset += price * user.holdings[stock];
    }
    const profitRate = (totalAsset / seedMoney) - 1;
    rankingArr.push({ name, profitRate, totalAsset });
  }
  rankingArr.sort((a,b) => b.profitRate - a.profitRate);
  rankingArr.forEach(({name, profitRate, totalAsset}, idx) => {
    const div = document.createElement("div");
    div.textContent = `${idx + 1}ìœ„: ${name} / ìˆ˜ìµë¥ : ${(profitRate * 100).toFixed(2)}% (ìì‚°: ${Math.floor(totalAsset).toLocaleString()} ì›)`;
    container.appendChild(div);
  });
}

function saveUsersData() {
  localStorage.setItem("users", JSON.stringify(users));
  if(currentUserName) localStorage.setItem("currentUserName", currentUserName);
}

function loadUsersData() {
  users = JSON.parse(localStorage.getItem("users")) || {};
  currentUserName = localStorage.getItem("currentUserName") || "";
}

function setUserName() {
  const input = document.getElementById("username");
  const name = input.value.trim();
  if (!name) {
    alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }
  currentUserName = name;
  if (!users[currentUserName]) {
    users[currentUserName] = { money: seedMoney, holdings: {} };
  }
  saveUsersData();
  updateInfo();
  updateRanking();
  alert(`${currentUserName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! ì´ˆê¸° ìê¸ˆì€ ${seedMoney.toLocaleString()}ì› ì…ë‹ˆë‹¤.`);
}

function initCurrentUser(name) {
  if (!users[name]) {
    users[name] = { money: seedMoney, holdings: {} };
  }
  currentUserName = name;
  document.getElementById("username").value = name;
  updateInfo();
  updateRanking();
}

function initChart() {
  const ctx = document.getElementById("stock-chart").getContext("2d");

  chartDatasets = stocks.map((stock, i) => ({
    label: stock,
    data: stockData[stock],
    borderColor: `hsl(${i * (360 / stocks.length)}, 70%, 50%)`,
    fill: false,
    tension: 0.1,
    hidden: stock !== currentStock
  }));

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: Array(50).fill("").map((_, i) => i - 49), // -49 ~ 0 (ìµœê·¼ 50ì´ˆ)
      datasets: chartDatasets
    },
    options: {
      animation: false,
      responsive: true,
      scales: {
        x: { display: true, title: { display: true, text: "ì‹œê°„(ì´ˆ)" } },
        y: { display: true, title: { display: true, text: "ê°€ê²©(ì›)" } }
      }
    }
  });
}

function updateChart() {
  chartDatasets.forEach(dataset => {
    dataset.data = stockData[dataset.label];
    dataset.hidden = dataset.label !== currentStock;
  });
  chart.update();
}

// 100ì´ˆë§ˆë‹¤ ì „ ì¢…ëª© 100% í­ë½ (ê°€ê²© ë°˜í† ë§‰)
setInterval(() => {
  stocks.forEach(stock => {
    let arr = stockData[stock];
    arr.shift();
    const newPrice = Math.max(1, Math.floor(arr[arr.length - 1] * 0.5));
    arr.push(newPrice);
  });
  updateChart();
  updateInfo();
  updateRanking();
  alert("ğŸ“‰ ì „ ì¢…ëª© ê°€ê²©ì´ ë°˜í† ë§‰ë‚¬ìŠµë‹ˆë‹¤! (100ì´ˆ ì´ë²¤íŠ¸)");
}, 100000);

// 150ì´ˆë§ˆë‹¤ ì „ ì¢…ëª© 120% í­ë“± (ê°€ê²© 2.2ë°°)
setInterval(() => {
  stocks.forEach(stock => {
    let arr = stockData[stock];
    arr.shift();
    const newPrice = Math.floor(arr[arr.length - 1] * 2.2);
    arr.push(newPrice);
  });
  updateChart();
  updateInfo();
  updateRanking();
  alert("ğŸš€ ì „ ì¢…ëª© ê°€ê²©ì´ 2.2ë°°ë¡œ í­ë“±í–ˆìŠµë‹ˆë‹¤! (150ì´ˆ ì´ë²¤íŠ¸)");
}, 150000);

window.onload = () => {
  loadUsersData();
  createStockButtons();
  initStockData();
  initChart();
  if (currentUserName) {
    initCurrentUser(currentUserName);
  }
  selectStock(currentStock);
  priceUpdateInterval = setInterval(updateStockPrices, 1000);
};
</script>

</body>
</html>
