<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>주식 시뮬레이터</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #stock-buttons button { margin: 5px; }
    #stock-info, #ranking { margin-top: 20px; }
    #holdings { margin-top: 20px; }
  </style>
</head>
<body>

<h1>주식 시뮬레이터</h1>

<div>
  사용자 이름: <input type="text" id="username" />
  <button onclick="setUserName()">설정</button>
</div>

<div id="stock-buttons"></div>

<div id="stock-info"></div>

<div id="holdings">
  <h3>보유 주식</h3>
  <div id="holdings-list"></div>
</div>

<canvas id="stock-chart" width="800" height="400"></canvas>

<div id="ranking">
  <h3>수익률 랭킹</h3>
  <div id="ranking-list"></div>
</div>

<script>
const stocks = [
  "삼성전자", "SK하이닉스", "네이버", "카카오", "LG전자", "현대자동차", "기아", "셀트리온",
  "NHN", "한화솔루션", "POSCO", "CJ대한통운", "카카오뱅크", "아모레퍼시픽", "저가주" // 저가주 천원대 추가
];

const seedMoney = 100000; // 초기 자금 10만원

let stockData = {};
let currentStock = stocks[0];
let users = {};
let currentUserName = "";
let priceUpdateInterval;
let chart;
let chartDatasets = [];

function initStockData() {
  stocks.forEach(stock => {
    stockData[stock] = [];
    let startPrice = stock === "저가주" ? 1000 : Math.floor(Math.random() * 90000 + 10000);
    for (let i = 0; i < 50; i++) {
      stockData[stock].push(startPrice);
    }
  });
}

function createStockButtons() {
  const container = document.getElementById("stock-buttons");
  container.innerHTML = "";
  stocks.forEach(stock => {
    const btn = document.createElement("button");
    btn.textContent = stock;
    btn.onclick = () => selectStock(stock);
    container.appendChild(btn);
  });
}

function selectStock(stock) {
  currentStock = stock;
  updateInfo();
  updateChart();
}

function updateStockPrices() {
  stocks.forEach(stock => {
    let arr = stockData[stock];
    arr.shift();

    // 기본 변동: 약간 상승 기조, 소폭 하락 가능성 포함
    let lastPrice = arr[arr.length - 1];
    let changePercent = (Math.random() - 0.4) * 0.03; // -1.2% ~ +1.8% 정도 변동, 상승이 더 큼
    let newPrice = Math.max(1, Math.floor(lastPrice * (1 + changePercent)));
    arr.push(newPrice);
  });
  updateChart();
  updateInfo();
  updateRanking();
}

function updateInfo() {
  const info = document.getElementById("stock-info");
  const price = stockData[currentStock][stockData[currentStock].length - 1];
  const holdings = users[currentUserName]?.holdings || {};
  const amount = holdings[currentStock] || 0;
  info.innerHTML = `
    <h2>${currentStock}</h2>
    <p>현재가: ${price.toLocaleString()} 원</p>
    <p>보유량: ${amount} 주</p>
    <button onclick="buyStock()">매수</button>
    <button onclick="sellStock()">매도</button>
  `;

  updateHoldings();
}

function buyStock() {
  if (!currentUserName) {
    alert("먼저 사용자 이름을 설정하세요.");
    return;
  }
  const price = stockData[currentStock][stockData[currentStock].length - 1];
  const user = users[currentUserName];
  if (user.money < price) {
    alert("잔액이 부족합니다.");
    return;
  }
  user.money -= price;
  user.holdings[currentStock] = (user.holdings[currentStock] || 0) + 1;
  saveUsersData();
  updateInfo();
  updateRanking();
}

function sellStock() {
  if (!currentUserName) {
    alert("먼저 사용자 이름을 설정하세요.");
    return;
  }
  const user = users[currentUserName];
  if ((user.holdings[currentStock] || 0) < 1) {
    alert("보유 주식이 없습니다.");
    return;
  }
  const price = stockData[currentStock][stockData[currentStock].length - 1];
  user.holdings[currentStock] -= 1;
  user.money += price;
  if (user.holdings[currentStock] === 0) {
    delete user.holdings[currentStock];
  }
  saveUsersData();
  updateInfo();
  updateRanking();
}

function updateHoldings() {
  const container = document.getElementById("holdings-list");
  container.innerHTML = "";
  if (!currentUserName) {
    container.textContent = "사용자 이름을 설정하세요.";
    return;
  }
  const holdings = users[currentUserName]?.holdings || {};
  for (const stock of stocks) {
    if ((holdings[stock] || 0) > 0) {
      const div = document.createElement("div");
      div.textContent = `${stock}: ${holdings[stock]} 주`;
      container.appendChild(div);
    }
  }
}

function updateRanking() {
  const container = document.getElementById("ranking-list");
  container.innerHTML = "";
  // 수익률 계산: (현재자산 / 초기자금) - 1
  let rankingArr = [];
  for (const name in users) {
    const user = users[name];
    let totalAsset = user.money;
    for (const stock in user.holdings) {
      const price = stockData[stock][stockData[stock].length - 1];
      totalAsset += price * user.holdings[stock];
    }
    const profitRate = (totalAsset / seedMoney) - 1;
    rankingArr.push({ name, profitRate, totalAsset });
  }
  rankingArr.sort((a,b) => b.profitRate - a.profitRate);
  rankingArr.forEach(({name, profitRate, totalAsset}, idx) => {
    const div = document.createElement("div");
    div.textContent = `${idx + 1}위: ${name} / 수익률: ${(profitRate * 100).toFixed(2)}% (자산: ${Math.floor(totalAsset).toLocaleString()} 원)`;
    container.appendChild(div);
  });
}

function saveUsersData() {
  localStorage.setItem("users", JSON.stringify(users));
  if(currentUserName) localStorage.setItem("currentUserName", currentUserName);
}

function loadUsersData() {
  users = JSON.parse(localStorage.getItem("users")) || {};
  currentUserName = localStorage.getItem("currentUserName") || "";
}

function setUserName() {
  const input = document.getElementById("username");
  const name = input.value.trim();
  if (!name) {
    alert("이름을 입력하세요.");
    return;
  }
  currentUserName = name;
  if (!users[currentUserName]) {
    users[currentUserName] = { money: seedMoney, holdings: {} };
  }
  saveUsersData();
  updateInfo();
  updateRanking();
  alert(`${currentUserName}님 환영합니다! 초기 자금은 ${seedMoney.toLocaleString()}원 입니다.`);
}

function initCurrentUser(name) {
  if (!users[name]) {
    users[name] = { money: seedMoney, holdings: {} };
  }
  currentUserName = name;
  document.getElementById("username").value = name;
  updateInfo();
  updateRanking();
}

function initChart() {
  const ctx = document.getElementById("stock-chart").getContext("2d");

  chartDatasets = stocks.map((stock, i) => ({
    label: stock,
    data: stockData[stock],
    borderColor: `hsl(${i * (360 / stocks.length)}, 70%, 50%)`,
    fill: false,
    tension: 0.1,
    hidden: stock !== currentStock
  }));

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: Array(50).fill("").map((_, i) => i - 49), // -49 ~ 0 (최근 50초)
      datasets: chartDatasets
    },
    options: {
      animation: false,
      responsive: true,
      scales: {
        x: { display: true, title: { display: true, text: "시간(초)" } },
        y: { display: true, title: { display: true, text: "가격(원)" } }
      }
    }
  });
}

function updateChart() {
  chartDatasets.forEach(dataset => {
    dataset.data = stockData[dataset.label];
    dataset.hidden = dataset.label !== currentStock;
  });
  chart.update();
}

// 100초마다 전 종목 100% 폭락 (가격 반토막)
setInterval(() => {
  stocks.forEach(stock => {
    let arr = stockData[stock];
    arr.shift();
    const newPrice = Math.max(1, Math.floor(arr[arr.length - 1] * 0.5));
    arr.push(newPrice);
  });
  updateChart();
  updateInfo();
  updateRanking();
  alert("📉 전 종목 가격이 반토막났습니다! (100초 이벤트)");
}, 100000);

// 150초마다 전 종목 120% 폭등 (가격 2.2배)
setInterval(() => {
  stocks.forEach(stock => {
    let arr = stockData[stock];
    arr.shift();
    const newPrice = Math.floor(arr[arr.length - 1] * 2.2);
    arr.push(newPrice);
  });
  updateChart();
  updateInfo();
  updateRanking();
  alert("🚀 전 종목 가격이 2.2배로 폭등했습니다! (150초 이벤트)");
}, 150000);

window.onload = () => {
  loadUsersData();
  createStockButtons();
  initStockData();
  initChart();
  if (currentUserName) {
    initCurrentUser(currentUserName);
  }
  selectStock(currentStock);
  priceUpdateInterval = setInterval(updateStockPrices, 1000);
};
</script>

</body>
</html>
