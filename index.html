<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    canvas { max-width: 100%; }
    .stock, .controls { margin-bottom: 20px; }
    input { width: 60px; }
    .ranking { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ğŸ“ˆ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h2>
  <div>
    ì‚¬ìš©ì ì´ë¦„: <input id="usernameInput" placeholder="ì´ë¦„ ì…ë ¥" />
    <button onclick="saveUsername()">ì €ì¥</button>
  </div>
  <div id="welcome"></div>
  <div class="stock">
    <canvas id="stockChart"></canvas>
  </div>
  <div class="controls">
    <p>ìê¸ˆ: <span id="money">100000</span>ì›</p>
    <p>ë³´ìœ  ë¡±: <span id="longHoldings">0</span>ì£¼ / ë³´ìœ  ìˆ: <span id="shortHoldings">0</span>ì£¼</p>
    <p>í˜„ì¬ ì£¼ê°€: <span id="currentPrice">-</span>ì›</p>
    <input type="number" id="qty" placeholder="ìˆ˜ëŸ‰" />
    <button onclick="buyStock('long')">ë¡± ë§¤ìˆ˜</button>
    <button onclick="sellStock('long')">ë¡± ë§¤ë„</button>
    <button onclick="buyStock('short')">ìˆ ë§¤ìˆ˜</button>
    <button onclick="sellStock('short')">ìˆ ë§¤ë„</button>
  </div>
  <div class="ranking">
    <h3>ğŸ† ìˆ˜ìµë¥  ë­í‚¹</h3>
    <ul id="rankingList"></ul>
  </div>

  <script>
    const ctx = document.getElementById('stockChart').getContext('2d');
    let price = 100;
    let prices = Array(30).fill(price);
    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({ length: 30 }, (_, i) => i + 1),
        datasets: [{
          label: 'ì£¼ê°€',
          data: prices,
          borderColor: 'blue',
          fill: false
        }]
      },
      options: { responsive: true }
    });

    let money = 100000;
    let longHoldings = 0;
    let shortHoldings = 0;
    let averageShortPrice = 0;
    let username = localStorage.getItem("username") || "";

    if (username) document.getElementById("welcome").textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${username}ë‹˜!`;

    function updateDisplay() {
      document.getElementById("money").textContent = money.toFixed(0);
      document.getElementById("longHoldings").textContent = longHoldings;
      document.getElementById("shortHoldings").textContent = shortHoldings;
      document.getElementById("currentPrice").textContent = price.toFixed(0);
    }

    function saveUsername() {
      username = document.getElementById("usernameInput").value;
      if (username) {
        localStorage.setItem("username", username);
        document.getElementById("welcome").textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${username}ë‹˜!`;
      }
    }

    function buyStock(position) {
      const qty = parseInt(document.getElementById("qty").value);
      if (!qty || qty <= 0) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const cost = qty * price;
      if (position === "long") {
        if (money >= cost) {
          money -= cost;
          longHoldings += qty;
        } else alert("ìê¸ˆ ë¶€ì¡±");
      } else if (position === "short") {
        shortHoldings += qty;
        averageShortPrice = ((averageShortPrice * (shortHoldings - qty)) + (price * qty)) / shortHoldings;
        money += cost;
      }
      updateDisplay();
      updateRanking();
    }

    function sellStock(position) {
      const qty = parseInt(document.getElementById("qty").value);
      if (!qty || qty <= 0) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if (position === "long") {
        if (longHoldings >= qty) {
          longHoldings -= qty;
          money += qty * price;
        } else alert("ë¡± ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡±");
      } else if (position === "short") {
        if (shortHoldings >= qty) {
          shortHoldings -= qty;
          const gain = (averageShortPrice - price) * qty;
          money -= price * qty;
          money += gain + price * qty;
        } else alert("ìˆ ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡±");
      }
      updateDisplay();
      updateRanking();
    }

    function updatePrice() {
      const change = (Math.random() - 0.5) * 4 + 0.5; // ì†Œí­ ìƒìŠ¹ ê²½í–¥
      price = Math.max(1, price + change);
      prices.push(price);
      prices.shift();
      chart.data.datasets[0].data = prices;
      chart.update();
      updateDisplay();
      updateRanking();
    }

    function updateRanking() {
      if (!username) return;
      const totalValue = money + longHoldings * price + shortHoldings * (averageShortPrice - price);
      localStorage.setItem(`ranking_${username}`, totalValue);
      displayRanking();
    }

    function displayRanking() {
      let rankingList = [];
      for (let key in localStorage) {
        if (key.startsWith("ranking_")) {
          let name = key.replace("ranking_", "");
          rankingList.push({ name, value: parseFloat(localStorage.getItem(key)) });
        }
      }
      rankingList.sort((a, b) => b.value - a.value);
      const ul = document.getElementById("rankingList");
      ul.innerHTML = "";
      rankingList.forEach((entry, i) => {
        const li = document.createElement("li");
        li.textContent = `${i + 1}. ${entry.name} - ì´ ìì‚°: ${entry.value.toFixed(0)}ì›`;
        ul.appendChild(li);
      });
    }

    updateDisplay();
    displayRanking();
    setInterval(updatePrice, 2000);
  </script>
</body>
</html>
