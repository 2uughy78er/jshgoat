<!DOCTYPE html><html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>모의 주식 시뮬레이터</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    .container { display: flex; gap: 20px; }
    .left, .right { flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    .stock-list div { margin-bottom: 8px; }
    .log { height: 150px; overflow-y: auto; background: #eee; padding: 10px; border-radius: 8px; }
    canvas { background: white; }
    .btn { padding: 5px 10px; margin-left: 4px; cursor: pointer; }
    .danger { background: red; color: white; }
  </style>
</head>
<body>
  <h1>📈 모의 주식 시뮬레이터</h1>
  <div class="container">
    <div class="left">
      <p>이름: <input id="username" placeholder="이름 입력"> <button onclick="saveName()">저장</button></p>
      <p>자금: <span id="money"></span>원</p>
      <div class="stock-list" id="stockList"></div>
      <p>보유 주식: <span id="holdings"></span></p>
      <button onclick="resetData()" class="btn danger">데이터 초기화</button>
    </div>
    <div class="right">
      <canvas id="chart"></canvas>
      <div class="log" id="log"></div>
    </div>
  </div>  <script>
    const stocks = Array.from({ length: 15 }, (_, i) => ({ name: `종목${i+1}`, price: i === 0 ? 1000 : Math.floor(Math.random() * 5000 + 1000) }));
    let money = 100000;
    let holdings = {};  // 종목별 보유수량
    let logs = [];
    let chart;
    let selected = stocks[0].name;

    function init() {
      const savedMoney = localStorage.getItem('money');
      if (savedMoney) money = parseInt(savedMoney);

      const savedHoldings = localStorage.getItem('holdings');
      if (savedHoldings) holdings = JSON.parse(savedHoldings);

      const savedLogs = localStorage.getItem('logs');
      if (savedLogs) logs = JSON.parse(savedLogs);

      const savedName = localStorage.getItem('username');
      if (savedName) document.getElementById('username').value = savedName;

      const savedPrices = JSON.parse(localStorage.getItem('prices'));
      if (savedPrices) {
        stocks.forEach(s => { if (savedPrices[s.name]) s.price = savedPrices[s.name]; });
      }

      updateUI();
      drawChart();
      setInterval(updatePrices, 3000);
      setInterval(() => { randomEvent('crash'); }, 100000);
      setInterval(() => { randomEvent('boom'); }, 150000);
    }

    function updateUI() {
      document.getElementById('money').innerText = money.toLocaleString();
      const list = document.getElementById('stockList');
      list.innerHTML = '';
      stocks.forEach(s => {
        const div = document.createElement('div');
        div.innerHTML = `${s.name} - ${s.price}원 
          <button class='btn' onclick="buy('${s.name}')">매수</button>
          <button class='btn' onclick="sell('${s.name}')">매도</button>
          <button class='btn' onclick="shortSell('${s.name}')">숏</button>
          <button class='btn' onclick="coverShort('${s.name}')">청산</button>
          <button class='btn' onclick="select('${s.name}')">차트</button>`;
        list.appendChild(div);
      });
      document.getElementById('holdings').innerText = JSON.stringify(holdings);
      document.getElementById('log').innerHTML = logs.slice(-20).reverse().join('<br>');
    }

    function updatePrices() {
      stocks.forEach(s => {
        const delta = Math.floor(Math.random() * 10 - 4);  // -4~+5
        s.price = Math.max(1, s.price + delta);
      });
      logAction('📊 주가 업데이트');
      savePrices();
      updateUI();
      updateChart();
    }

    function buy(name) {
      const s = stocks.find(x => x.name === name);
      if (money >= s.price) {
        money -= s.price;
        holdings[name] = (holdings[name] || 0) + 1;
        logAction(`✅ ${name} 매수 (${s.price}원)`);
        saveAll(); updateUI();
      }
    }

    function sell(name) {
      if (holdings[name] > 0) {
        const s = stocks.find(x => x.name === name);
        money += s.price;
        holdings[name]--;
        if (holdings[name] === 0) delete holdings[name];
        logAction(`📤 ${name} 매도 (${s.price}원)`);
        saveAll(); updateUI();
      }
    }

    function shortSell(name) {
      holdings[`short_${name}`] = (holdings[`short_${name}`] || 0) + 1;
      money += stocks.find(x => x.name === name).price;
      logAction(`📉 ${name} 숏 포지션`);
      saveAll(); updateUI();
    }

    function coverShort(name) {
      const key = `short_${name}`;
      if (holdings[key] > 0) {
        const s = stocks.find(x => x.name === name);
        money -= s.price;
        holdings[key]--;
        if (holdings[key] === 0) delete holdings[key];
        logAction(`📈 ${name} 숏 청산 (${s.price}원)`);
        saveAll(); updateUI();
      }
    }

    function select(name) {
      selected = name;
      updateChart();
    }

    function logAction(msg) {
      logs.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
      localStorage.setItem('logs', JSON.stringify(logs));
    }

    function saveAll() {
      localStorage.setItem('money', money);
      localStorage.setItem('holdings', JSON.stringify(holdings));
      localStorage.setItem('logs', JSON.stringify(logs));
      savePrices();
    }

    function savePrices() {
      const saved = {};
      stocks.forEach(s => saved[s.name] = s.price);
      localStorage.setItem('prices', JSON.stringify(saved));
    }

    function drawChart() {
      const ctx = document.getElementById('chart');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array(50).fill(''),
          datasets: [{ label: selected, data: [], borderColor: 'blue' }]
        },
        options: { animation: false }
      });
    }

    function updateChart() {
      const s = stocks.find(x => x.name === selected);
      const ds = chart.data.datasets[0];
      ds.label = selected;
      ds.data.push(s.price);
      if (ds.data.length > 50) ds.data.shift();
      chart.update();
    }

    function saveName() {
      localStorage.setItem('username', document.getElementById('username').value);
    }

    function randomEvent(type) {
      const s = stocks[Math.floor(Math.random() * stocks.length)];
      if (type === 'crash') {
        const rate = Math.random() * 0.3 + 0.7; // 70~100%
        s.price = Math.max(1, Math.floor(s.price * (1 - rate)));
        logAction(`${s.name} 📉 주가 ${Math.floor(rate * 100)}% 폭락!`);
      } else {
        const rate = Math.random() * 0.2 + 1.0; // 100~120%
        s.price = Math.floor(s.price * (1 + rate));
        logAction(`${s.name} 🚀 주가 ${Math.floor(rate * 100)}% 폭등!`);
      }
      savePrices(); updateUI();
    }

    function resetData() {
      if (confirm('정말로 모든 데이터를 초기화하시겠습니까?')) {
        localStorage.clear();
        location.reload();
      }
    }

    window.onload = init;
  </script></body>
</html>
