<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>모의주식 숏 포지션 시뮬레이터</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #stockList button { margin: 3px; padding: 5px 10px; }
  #tradeArea { margin-top: 20px; }
  #tradeArea input { width: 60px; }
  #log { margin-top: 20px; max-height: 200px; overflow-y: auto; background: #f0f0f0; padding: 10px; }
  #portfolio { margin-top: 20px; }
</style>
</head>
<body>

<h1>모의주식 숏 포지션 시뮬레이터</h1>
<div>이름: <input id="userName" placeholder="이름 입력" /></div>
<button id="btnSaveName">이름 저장</button>
<div id="welcomeMsg"></div>
<hr />

<div><strong>현금:</strong> <span id="cashDisplay"></span> 원</div>
<div><strong>선택 종목:</strong> <span id="selectedStockName"></span></div>
<div><strong>현재가:</strong> <span id="currentPrice"></span> 원</div>
<div><strong>보유 숏 수량:</strong> <span id="ownedStock"></span> 주</div>
<div><strong>현재 손익률:</strong> <span id="profitRate"></span> %</div>

<div id="stockList"></div>

<div id="tradeArea">
  <input type="number" id="tradeAmount" min="1" value="1" />
  <button id="btnShortSell">숏 포지션 진입(매도)</button>
  <button id="btnShortCover">숏 포지션 청산(매수)</button>
  <p>최대 매도 가능 주식 수 (숏 진입): <span id="maxShortSell">0</span></p>
  <p>최대 매수 가능 주식 수 (숏 청산): <span id="maxShortCover">0</span></p>
</div>

<canvas id="stockChart" width="600" height="300"></canvas>

<div id="log"><strong>거래 내역:</strong><br></div>

<script>
(() => {
  // 종목 데이터 초기화
  const STOCKS = [
    { code:"005930", name:"삼성전자", price:70000, owned:0, boughtPrice: 0 },
    { code:"000660", name:"SK하이닉스", price:110000, owned:0, boughtPrice: 0 },
    { code:"035420", name:"NAVER", price:350000, owned:0, boughtPrice: 0 },
    { code:"051910", name:"LG화학", price:900000, owned:0, boughtPrice: 0 },
    { code:"207940", name:"삼성바이오로직스", price:750000, owned:0, boughtPrice: 0 },
    { code:"005380", name:"현대차", price:230000, owned:0, boughtPrice: 0 },
    { code:"035720", name:"카카오", price:70000, owned:0, boughtPrice: 0 },
    { code:"066570", name:"LG전자", price:110000, owned:0, boughtPrice: 0 },
    { code:"012330", name:"현대모비스", price:300000, owned:0, boughtPrice: 0 },
    { code:"096770", name:"SK이노베이션", price:250000, owned:0, boughtPrice: 0 },
    { code:"105560", name:"KB금융", price:54000, owned:0, boughtPrice: 0 },
    { code:"015760", name:"한국전력", price:23000, owned:0, boughtPrice: 0 },
    { code:"028260", name:"삼성물산", price:130000, owned:0, boughtPrice: 0 },
    { code:"010950", name:"S-Oil", price:65000, owned:0, boughtPrice: 0 },
    { code:"000020", name:"동화약품", price:1000, owned:0, boughtPrice: 0 } // 1000원 저가 종목
  ];

  let state = {
    cash: 1000000, // 초기 자금 100만원
    stocks: JSON.parse(JSON.stringify(STOCKS)),
    selectedIndex: 0,
    trades: [], // 거래 내역: {time, stockName, type, amount, price, profitRate}
    userName: '',
  };

  // 로컬스토리지에서 불러오기
  function loadState(){
    const saved = localStorage.getItem('shortSimState');
    if(saved){
      const parsed = JSON.parse(saved);
      state.cash = parsed.cash;
      state.stocks = parsed.stocks;
      state.selectedIndex = parsed.selectedIndex || 0;
      state.trades = parsed.trades || [];
      state.userName = parsed.userName || '';
    }
  }
  // 저장하기
  function saveState(){
    localStorage.setItem('shortSimState', JSON.stringify({
      cash: state.cash,
      stocks: state.stocks,
      selectedIndex: state.selectedIndex,
      trades: state.trades,
      userName: state.userName,
    }));
  }

  // UI요소들
  const cashDisplay = document.getElementById('cashDisplay');
  const stockListDiv = document.getElementById('stockList');
  const selectedStockNameSpan = document.getElementById('selectedStockName');
  const currentPriceSpan = document.getElementById('currentPrice');
  const ownedStockSpan = document.getElementById('ownedStock');
  const profitRateSpan = document.getElementById('profitRate');
  const tradeAmountInput = document.getElementById('tradeAmount');
  const btnShortSell = document.getElementById('btnShortSell');
  const btnShortCover = document.getElementById('btnShortCover');
  const maxShortSellSpan = document.getElementById('maxShortSell');
  const maxShortCoverSpan = document.getElementById('maxShortCover');
  const logDiv = document.getElementById('log');
  const userNameInput = document.getElementById('userName');
  const btnSaveName = document.getElementById('btnSaveName');
  const welcomeMsg = document.getElementById('welcomeMsg');

  // 차트 관련 변수
  let chart = null;
  let chartData = {
    labels: [],
    datasets: [{
      label: '',
      data: [],
      borderColor: 'blue',
      backgroundColor: 'rgba(0,0,255,0.1)',
      fill: true,
      tension: 0.3
    }]
  };

  // 차트 초기화
  function initChart(stockName){
    if(chart){
      chart.destroy();
    }
    chartData.labels = [];
    chartData.datasets[0].label = stockName;
    chartData.datasets[0].data = [];
    const ctx = document.getElementById('stockChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        animation: false,
        responsive: false,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  }

  // 차트에 데이터 추가 (최대 50개 유지)
  function addChartData(price){
    const now = new Date();
    const label = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
    chartData.labels.push(label);
    chartData.datasets[0].data.push(price);
    if(chartData.labels.length > 50){
      chartData.labels.shift();
      chartData.datasets[0].data.shift();
    }
    chart.update();
  }

  // 선택된 종목 가져오기
  function getSelectedStock(){
    return state.stocks[state.selectedIndex];
  }

  // UI 업데이트
  function updateUI(){
    cashDisplay.textContent = state.cash.toLocaleString();
    const stock = getSelectedStock();
    selectedStockNameSpan.textContent = stock.name;
    currentPriceSpan.textContent = stock.price.toLocaleString();
    ownedStockSpan.textContent = stock.owned;
    // 손익률 계산: (boughtPrice - currentPrice) / boughtPrice * 100 (숏 포지션 손익률)
    if(stock.owned > 0 && stock.boughtPrice > 0){
      let profit = (stock.boughtPrice - stock.price) / stock.boughtPrice * 100;
      profitRateSpan.textContent = profit.toFixed(2);
    } else {
      profitRateSpan.textContent = '0.00';
    }

    updateMaxAmounts();
    renderStockButtons();
  }

  // 종목 버튼 리스트 렌더링
  function renderStockButtons(){
    stockListDiv.innerHTML = '';
    state.stocks.forEach((s,i) => {
      const btn = document.createElement('button');
      btn.textContent = `${s.name} (${s.price.toLocaleString()}원)`;
      if(i === state.selectedIndex){
        btn.style.fontWeight = 'bold';
        btn.style.backgroundColor = '#cce5ff';
      }
      btn.addEventListener('click', () => {
        state.selectedIndex = i;
        updateUI();
        initChart(state.stocks[state.selectedIndex].name);
        // 차트 초기 데이터 세팅
        chartData.labels = [];
        chartData.datasets[0].data = [];
        addChartData(state.stocks[state.selectedIndex].price);
      });
      stockListDiv.appendChild(btn);
    });
  }

  // 최대 매도/매수 가능한 수량 계산 및 UI 표시
  function updateMaxAmounts(){
    const stock = getSelectedStock();
    if(!stock){
      maxShortSellSpan.textContent = '0';
      maxShortCoverSpan.textContent = '0';
      return;
    }
    // 최대 숏 진입 가능 수량 = 현금 / 현재가 (내가 팔 수 있는 최대량)
    const maxShortSell = Math.floor(state.cash / stock.price);
    maxShortSellSpan.textContent = maxShortSell;

    // 최대 숏 청산 가능 수량 = 보유 숏 수량
    maxShortCoverSpan.textContent = stock.owned;
  }

  // 거래 내역 로그 추가
  function addLog(text){
    const p = document.createElement('p');
    p.textContent = text;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // 거래 실행 (숏 포지션 진입 = 매도, 숏 포지션 청산 = 매수)
  // type: 'shortSell' 또는 'shortCover'
  function doTrade(type){
    const stock = getSelectedStock();
    let amount = parseInt(tradeAmountInput.value);
    if(isNaN(amount) || amount < 1){
      alert('거래 수량을 올바르게 입력하세요.');
      return;
    }
    if(type === 'shortSell'){
      // 숏 포지션 진입: 매도 주식 수량만큼 현금 증가, 보유 숏 수량 증가, 평균 매입가 갱신
      const maxSell = Math.floor(state.cash / stock.price);
      if(amount > maxSell){
        alert(`최대 ${maxSell}주까지 숏 포지션 진입 가능합니다.`);
        return;
      }
      const cost = stock.price * amount;
      state.cash += cost; // 숏 진입시 현금 증가 (주식을 빌려 팔았으므로)
      // 평균 매입가 계산 (가중 평균)
      let totalOwned = stock.owned + amount;
      if(stock.owned === 0){
        stock.boughtPrice = stock.price;
      } else {
        stock.boughtPrice = (stock.boughtPrice * stock.owned + stock.price * amount) / totalOwned;
      }
      stock.owned = totalOwned;

      addLog(`[${new Date().toLocaleTimeString()}] ${stock.name} 숏 포지션 진입 ${amount}주 @${stock.price.toLocaleString()}원`);
    }
    else if(type === 'shortCover'){
      // 숏 포지션 청산: 매수 주식 수량만큼 현금 감소, 보유 숏 수량 감소, 손익률 기록
      if(amount > stock.owned){
        alert(`최대 ${stock.owned}주까지 숏 포지션 청산 가능합니다.`);
        return;
      }
      const cost = stock.price * amount;
      if(cost > state.cash){
        alert(`현금이 부족합니다. 현금: ${state.cash.toLocaleString()}원`);
        return;
      }
      state.cash -= cost; // 숏 청산시 주식 매수하므로 현금 감소
      stock.owned -= amount;

      // 손익률 계산
      const profit = (stock.boughtPrice - stock.price) / stock.boughtPrice * 100;

      addLog(`[${new Date().toLocaleTimeString()}] ${stock.name} 숏 포지션 청산 ${amount}주 @${stock.price.toLocaleString()}원, 손익률: ${profit.toFixed(2)}%`);

      // 만약 숏 포지션이 모두 청산되면 평균 매입가 초기화
      if(stock.owned === 0){
        stock.boughtPrice = 0;
      }
    }
    else {
      alert('잘못된 거래 유형입니다.');
      return;
    }
    saveState();
    updateUI();
    addChartData(stock.price);
  }

  // 5초마다 주가 랜덤 변동 (±3%)
  function randomPriceChange(){
    state.stocks.forEach(stock => {
      const changeRate = (Math.random()*6 - 3) / 100; // -3% ~ +3%
      const newPrice = Math.max(100, Math.floor(stock.price * (1 + changeRate)));
      stock.price = newPrice;
    });
  }

  // 100초마다 랜덤 종목 70~100% 폭락
  function crashRandomStock(){
    const i = Math.floor(Math.random()*state.stocks.length);
    const stock = state.stocks[i];
    const crashRate = (Math.random() * 0.3) + 0.7; // 0.7 ~ 1.0
    stock.price = Math.max(100, Math.floor(stock.price * crashRate));
    addLog(`[${new Date().toLocaleTimeString()}] ${stock.name} 폭락! 현재가: ${stock.price.toLocaleString()}원`);
  }

  // 150초마다 랜덤 종목 100~120% 폭등
  function surgeRandomStock(){
    const i = Math.floor(Math.random()*state.stocks.length);
    const stock = state.stocks[i];
    const surgeRate = (Math.random() * 0.2) + 1.0; // 1.0 ~ 1.2
    stock.price = Math.floor(stock.price * surgeRate);
    addLog(`[${new Date().toLocaleTimeString()}] ${stock.name} 폭등! 현재가: ${stock.price.toLocaleString()}원`);
  }

  // 주기적 이벤트 세팅
  function startIntervals(){
    setInterval(() => {
      randomPriceChange();
      saveState();
      updateUI();
      const stock = getSelectedStock();
      addChartData(stock.price);
    }, 5000);

    setInterval(() => {
      crashRandomStock();
      saveState();
      updateUI();
      const stock = getSelectedStock();
      addChartData(stock.price);
    }, 100000);

    setInterval(() => {
      surgeRandomStock();
      saveState();
      updateUI();
      const stock = getSelectedStock();
      addChartData(stock.price);
    }, 150000);
  }

  // 유저 이름 저장
  btnSaveName.onclick = () => {
    const name = userNameInput.value.trim();
    if(name){
      state.userName = name;
      saveState();
      welcomeMsg.textContent = `${name}님, 환영합니다!`;
    }
  };

  // 이벤트 바인딩
  btnShortSell.onclick = () => doTrade('shortSell');
  btnShortCover.onclick = () => doTrade('shortCover');

  // 초기 실행
  loadState();
  if(state.userName) {
    userNameInput.value = state.userName;
    welcomeMsg.textContent = `${state.userName}님, 환영합니다!`;
  }
  renderStockButtons();
  updateUI();
  initChart(state.stocks[state.selectedIndex].name);
  addChartData(state.stocks[state.selectedIndex].price);
  startIntervals();

})();
</script>

</body>
</html>
