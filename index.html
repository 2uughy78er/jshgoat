<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ ì£¼ì‹ ê±°ë˜ ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      display: flex;
      font-family: sans-serif;
      margin: 0;
    }
    #sidebar {
      width: 200px;
      border-right: 1px solid #ccc;
      padding: 10px;
      background-color: #f4f4f4;
    }
    #main {
      flex: 1;
      padding: 10px;
    }
    canvas {
      max-width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 5px;
      text-align: center;
    }
    .info {
      margin-top: 10px;
    }
    button {
      margin: 2px;
      padding: 5px;
    }
    input[type="number"] {
      width: 60px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>ì¢…ëª© ì„ íƒ</h3>
    <div id="stockButtons"></div>
  </div>
  <div id="main">
    <h2 id="stock-title">ì£¼ì‹ ì°¨íŠ¸</h2>
    <canvas id="stockChart" height="100"></canvas>
    <div class="info">
      <p>ğŸ’° í˜„ì¬ ìì‚°: <span id="cash"></span>ì›</p>
      <p>ğŸ“¦ ë³´ìœ  ìˆ˜ëŸ‰: <span id="shares"></span>ì£¼</p>
      <p>ğŸ’¹ í˜„ì¬ ì£¼ê°€: <span id="currentPrice"></span>ì›</p>
      <p>ğŸ“ˆ ìˆ˜ìµ/ì†ì‹¤: <span id="profit">0ì›</span></p>
      <input id="tradeAmount" type="number" value="1" min="1" />
      <button onclick="buyStock()">ë§¤ìˆ˜</button>
      <button onclick="sellStock()">ë§¤ë„</button>
    </div>
    <h3>ğŸ“‹ ê±°ë˜ ë‚´ì—­</h3>
    <table id="tradeLog">
      <thead>
        <tr>
          <th>ì‹œê°„</th>
          <th>ì¢…ëª©</th>
          <th>êµ¬ë¶„</th>
          <th>ê°€ê²©</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ì´ì•¡</th>
          <th>ì†ìµ</th>
          <th>ì†ìµë¥ </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const ctx = document.getElementById('stockChart').getContext('2d');
    const stocks = [
      'ì´ˆê¸°íˆ¬ì', 'ì‚¼ì„±ì „ì', 'í˜„ëŒ€ì°¨', 'LGì „ì', 'ì¹´ì¹´ì˜¤', 'ë„¤ì´ë²„',
      'ì…€íŠ¸ë¦¬ì˜¨', 'POSCO', 'SKí•˜ì´ë‹‰ìŠ¤', 'ê¸°ì•„', 'í•œí™”ì†”ë£¨ì…˜',
      'NAVER', 'ì‹ í•œì§€ì£¼', 'KBê¸ˆìœµ', 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', 'ë¡¯ë°ì¼€ë¯¸ì¹¼'
    ];

    const startPrices = {
      'ì´ˆê¸°íˆ¬ì': 1000,
      'ì‚¼ì„±ì „ì': 60000,
      'í˜„ëŒ€ì°¨': 220000,
      'LGì „ì': 130000,
      'ì¹´ì¹´ì˜¤': 70000,
      'ë„¤ì´ë²„': 300000,
      'ì…€íŠ¸ë¦¬ì˜¨': 250000,
      'POSCO': 300000,
      'SKí•˜ì´ë‹‰ìŠ¤': 110000,
      'ê¸°ì•„': 85000,
      'í•œí™”ì†”ë£¨ì…˜': 36000,
      'NAVER': 300000,
      'ì‹ í•œì§€ì£¼': 40000,
      'KBê¸ˆìœµ': 47000,
      'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤': 850000,
      'ë¡¯ë°ì¼€ë¯¸ì¹¼': 300000
    };

    let currentStock = stocks[0];
    let currentIndex = 50;
    const maxDataLength = 50;

    function getRandomPrice(prev, stock) {
      let change;
      if (stock === "ì´ˆê¸°íˆ¬ì") {
        change = Math.random() < 0.7 ? Math.random() * 0.05 : -Math.random() * 0.03;
      } else {
        change = (Math.random() - 0.5) * 0.06;
      }
      return Math.max(1, Math.round(prev * (1 + change)));
    }

    function generateInitialData(stock) {
      const arr = [startPrices[stock]];
      for (let i = 1; i < maxDataLength; i++) {
        arr.push(getRandomPrice(arr[i - 1], stock));
      }
      return arr;
    }

    const stockData = {};
    stocks.forEach(stock => stockData[stock] = generateInitialData(stock));

    let userHoldings = {
      cash: 50000,
      shares: {},
      avgBuyPrice: {},
      tradeLog: []
    };
    stocks.forEach(s => {
      userHoldings.shares[s] = 0;
      userHoldings.avgBuyPrice[s] = null;
    });

    function saveData() {
      localStorage.setItem("stockUserData", JSON.stringify(userHoldings));
    }

    function loadData() {
      const data = localStorage.getItem("stockUserData");
      if (data) userHoldings = JSON.parse(data);
    }

    loadData();

    const data = {
      labels: Array.from({ length: maxDataLength }, (_, i) => i),
      datasets: [{
        label: currentStock,
        borderColor: 'blue',
        backgroundColor: 'lightblue',
        data: [...stockData[currentStock]],
        tension: 0.4
      }]
    };

    const chart = new Chart(ctx, {
      type: 'line',
      data,
      options: {
        animation: false,
        responsive: true,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });

    stocks.forEach(stock => {
      const btn = document.createElement("button");
      btn.innerText = stock;
      btn.onclick = () => selectStock(stock);
      document.getElementById("stockButtons").appendChild(btn);
    });

    function selectStock(name) {
      currentStock = name;
      document.getElementById("stock-title").innerText = name;
      chart.data.datasets[0].label = name;
      chart.data.datasets[0].data = stockData[name];
      chart.update();
      updateInfo();
      renderTradeLog();
    }

    function getCurrentPrice() {
      return stockData[currentStock][stockData[currentStock].length - 1];
    }

    function buyStock() {
      const qty = parseInt(document.getElementById("tradeAmount").value);
      const price = getCurrentPrice();
      const total = qty * price;
      if (userHoldings.cash >= total && qty > 0) {
        const oldQty = userHoldings.shares[currentStock];
        const oldAvg = userHoldings.avgBuyPrice[currentStock] || 0;
        const newQty = oldQty + qty;
        const newAvg = (oldAvg * oldQty + price * qty) / newQty;

        userHoldings.cash -= total;
        userHoldings.shares[currentStock] = newQty;
        userHoldings.avgBuyPrice[currentStock] = newAvg;

        userHoldings.tradeLog.unshift({
          time: new Date().toLocaleTimeString(),
          stock: currentStock,
          type: 'ë§¤ìˆ˜',
          price, quantity: qty,
          total, profit: 0, rate: "0%"
        });

        saveData();
        updateInfo();
        renderTradeLog();
      } else {
        alert("ìê¸ˆì´ ë¶€ì¡±í•˜ê±°ë‚˜ ìˆ˜ëŸ‰ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
      }
    }

    function sellStock() {
      const qty = parseInt(document.getElementById("tradeAmount").value);
      const owned = userHoldings.shares[currentStock];
      const price = getCurrentPrice();
      const avg = userHoldings.avgBuyPrice[currentStock];

      if (owned >= qty && qty > 0) {
        const total = price * qty;
        const profit = (price - avg) * qty;
        const rate = avg ? ((price - avg) / avg * 100).toFixed(2) + "%" : "-";

        userHoldings.cash += total;
        userHoldings.shares[currentStock] -= qty;
        if (userHoldings.shares[currentStock] === 0) userHoldings.avgBuyPrice[currentStock] = null;

        userHoldings.tradeLog.unshift({
          time: new Date().toLocaleTimeString(),
          stock: currentStock,
          type: 'ë§¤ë„',
          price, quantity: qty,
          total, profit, rate
        });

        saveData();
        updateInfo();
        renderTradeLog();
      } else {
        alert("ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡± ë˜ëŠ” ì…ë ¥ ì˜¤ë¥˜");
      }
    }

    function updateInfo() {
      const price = getCurrentPrice();
      const qty = userHoldings.shares[currentStock];
      const avg = userHoldings.avgBuyPrice[currentStock];
      const value = qty * price;
      const invested = qty * avg;
      const profit = invested ? (value - invested) : 0;
      const rate = invested ? ((profit / invested) * 100).toFixed(2) + "%" : "0%";

      document.getElementById("cash").innerText = Math.floor(userHoldings.cash).toLocaleString();
      document.getElementById("shares").innerText = qty;
      document.getElementById("currentPrice").innerText = price.toLocaleString();
      document.getElementById("profit").innerText = `${profit >= 0 ? "+" : ""}${profit.toLocaleString()}ì› (${rate})`;
      document.getElementById("profit").style.color = profit >= 0 ? "green" : "red";
    }

    function renderTradeLog() {
      const tbody = document.querySelector("#tradeLog tbody");
      tbody.innerHTML = "";
      userHoldings.tradeLog.forEach(log => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${log.time}</td>
          <td>${log.stock}</td>
          <td>${log.type}</td>
          <td>${log.price.toLocaleString()}</td>
          <td>${log.quantity}</td>
          <td>${log.total.toLocaleString()}</td>
          <td>${log.type === "ë§¤ë„" ? log.profit.toLocaleString() : '-'}</td>
          <td>${log.type === "ë§¤ë„" ? log.rate : '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    setInterval(() => {
      stocks.forEach(stock => {
        const prices = stockData[stock];
        const newPrice = getRandomPrice(prices[prices.length - 1], stock);
        prices.push(newPrice);
        if (prices.length > maxDataLength) prices.shift();
      });
      chart.update();
      updateInfo();
    }, 1000);

    selectStock(currentStock);
  </script>
</body>
</html>
