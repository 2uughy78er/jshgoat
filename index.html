<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ ì£¼ì‹ ê±°ë˜ ì‹œë®¬ë ˆì´í„° (ë¡±/ìˆ + í­ë“±/í­ë½)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
    }
    .sidebar {
      width: 220px;
      background: #f5f5f5;
      padding: 10px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .chart-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .stock-list button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
    }
    .controls {
      margin-top: 10px;
    }
    .info {
      margin-top: 10px;
    }
    .log-table, .log-table th, .log-table td {
      border: 1px solid #ccc;
      border-collapse: collapse;
    }
    .log-table th, .log-table td {
      padding: 5px;
      text-align: center;
    }
    .rankings {
      margin-top: 20px;
      font-size: 14px;
    }
    .max-buy {
      margin-top: 5px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>ì¢…ëª© ì„ íƒ</h2>
    <div class="stock-list" id="stockButtons"></div>
    <div class="rankings">
      <h3>ğŸ† ìˆ˜ìµë¥  ìˆœìœ„</h3>
      <ul id="rankList"></ul>
    </div>
    <div style="margin-top:20px;">
      <label for="userNameInput">ì‚¬ìš©ì ì´ë¦„:</label><br />
      <input type="text" id="userNameInput" placeholder="ì´ë¦„ ì…ë ¥" />
      <button id="setNameBtn">ì„¤ì •</button>
    </div>
  </div>

  <div class="chart-container">
    <h1 id="stock-title">ì´ˆê¸°íˆ¬ì</h1>
    <div style="font-size: 18px; margin-bottom: 15px;">
      í˜„ì¬ ì£¼ê°€: <span id="currentPrice" style="font-weight: bold;">0</span>ì›
    </div>
    <div class="controls">
      <input type="number" id="tradeAmount" value="1" min="1" />
      <button onclick="buyStock()">ğŸŸ¢ ë§¤ìˆ˜ (ë¡± ì§„ì…)</button>
      <button onclick="sellStock()">ğŸ”´ ë§¤ë„ (ë¡± ì²­ì‚°)</button><br /><br />
      <button onclick="shortSell()">ğŸ“‰ ìˆë§¤ìˆ˜ (ìˆ ì§„ì…)</button>
      <button onclick="shortBuy()">ğŸ“ˆ ìˆë§¤ë„ (ìˆ ì²­ì‚°)</button>
      <div class="max-buy" id="maxBuy"></div>
      <div class="info">
        ğŸ’° ìê¸ˆ: <span id="cash">-</span>ì›<br />
        ğŸ’¼ ë³´ìœ  ìˆ˜ëŸ‰: <span id="shares">-</span>ê°œ<br />
        ğŸŸ  ìˆ í¬ì§€ì…˜: <span id="shortShares">-</span>ê°œ<br />
      </div>
    </div>
    <canvas id="stockChart" width="1200" height="400"></canvas>
    <h3>ğŸ“‹ ê±°ë˜ ë‚´ì—­</h3>
    <table class="log-table" id="tradeLog">
      <thead>
        <tr>
          <th>ì‹œê°„</th>
          <th>ì¢…ëª©</th>
          <th>êµ¬ë¶„</th>
          <th>ë‹¨ê°€</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ì´ì•¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const stocks = ['ì´ˆê¸°íˆ¬ì', 'ì‚¼ì„±ì „ì', 'í˜„ëŒ€ì°¨', 'LGì „ì', 'ì¹´ì¹´ì˜¤', 'ë„¤ì´ë²„', 'ì…€íŠ¸ë¦¬ì˜¨', 'POSCO', 'SKí•˜ì´ë‹‰ìŠ¤', 'ê¸°ì•„'];
  const startPrices = {
    'ì´ˆê¸°íˆ¬ì': 1000, 'ì‚¼ì„±ì „ì': 60000, 'í˜„ëŒ€ì°¨': 220000, 'LGì „ì': 130000,
    'ì¹´ì¹´ì˜¤': 70000, 'ë„¤ì´ë²„': 300000, 'ì…€íŠ¸ë¦¬ì˜¨': 250000, 'POSCO': 300000,
    'SKí•˜ì´ë‹‰ìŠ¤': 110000, 'ê¸°ì•„': 85000
  };
  const maxDataLength = 50;
  const initialCash = 100000;

  let currentUserName = null;
  let usersData = {};
  let currentStock = stocks[0];
  let stockData = {};
  let chart, data;
  let priceUpdateInterval = null;

  // í­ë½, í­ë“± ì¹´ìš´í„°
  let crashCounter = 0;
  let boomCounter = 0;

  // ëœë¤ ê°€ê²© ìƒì„± í•¨ìˆ˜
  function getRandomPrice(prevPrice, isCrash = false, isBoom = false) {
    let changePercent = 0;
    if (isCrash) {
      // í­ë½: -90% ~ -100%
      changePercent = -0.9 - Math.random() * 0.1;
    } else if (isBoom) {
      // í­ë“±: +120% (ì¦‰, 2.2ë°°)
      changePercent = 1.2;
    } else {
      // ì¼ë°˜ ë³€ë™: -0.5% ~ +0.5%
      changePercent = (Math.random() - 0.5) * 0.01;
    }
    return Math.max(1, Math.round(prevPrice * (1 + changePercent)));
  }

  function generateInitialData(startPrice) {
    const arr = [startPrice];
    for (let i = 1; i < maxDataLength; i++) {
      arr.push(getRandomPrice(arr[i - 1]));
    }
    return arr;
  }

  function initStockData() {
    stocks.forEach(stock => {
      stockData[stock] = generateInitialData(startPrices[stock]);
    });
  }

  function updateStockPrices() {
    crashCounter++;
    boomCounter++;

    const isCrash = crashCounter >= 30; // 30ì´ˆë§ˆë‹¤ í­ë½
    const isBoom = boomCounter >= 45;   // 45ì´ˆë§ˆë‹¤ í­ë“±

    if (isCrash) crashCounter = 0;
    if (isBoom) boomCounter = 0;

    stocks.forEach(stock => {
      const arr = stockData[stock];
      const prevPrice = arr[arr.length - 1];
      const newPrice = getRandomPrice(prevPrice, isCrash, isBoom);
      arr.push(newPrice);
      if (arr.length > maxDataLength) arr.shift();
    });

    updateChart();
    updateInfo();
    updateRanking();
  }

  function updateChart() {
    const labels = stockData[currentStock].map((_, i) => i + 1);
    const dataPrices = stockData[currentStock];

    if (!chart) {
      const ctx = document.getElementById('stockChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: currentStock,
            data: dataPrices,
            borderColor: 'blue',
            backgroundColor: 'rgba(0,0,255,0.1)',
            fill: true,
            tension: 0.2,
          }]
        },
        options: {
          animation: false,
          responsive: true,
          scales: {
            y: { beginAtZero: false }
          }
        }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].label = currentStock;
      chart.data.datasets[0].data = dataPrices;
      chart.update();
    }
  }

  function loadUsersData() {
    const saved = localStorage.getItem('stockSimData');
    usersData = saved ? JSON.parse(saved) : {};
  }

  function saveUsersData() {
    localStorage.setItem('stockSimData', JSON.stringify(usersData));
  }

  function initCurrentUser(name) {
    currentUserName = name;
    localStorage.setItem('currentUserName', name);
    if (!usersData[name]) {
      usersData[name] = {
        cash: initialCash,
        stocks: {},
        shortStocks: {},
        trades: []
      };
    }
    saveUsersData();
    updateInfo();
    updateTradeLog();
    updateRanking();
  }

  // ë¡±ë§¤ìˆ˜
  function buyStock() {
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if (isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ ì˜¤ë¥˜");
    const price = stockData[currentStock].slice(-1)[0];
    const totalCost = price * amount;
    if (usersData[currentUserName].cash < totalCost) return alert("ìê¸ˆ ë¶€ì¡±");

    usersData[currentUserName].cash -= totalCost;
    usersData[currentUserName].stocks[currentStock] = (usersData[currentUserName].stocks[currentStock] || 0) + amount;
    usersData[currentUserName].trades.push({ time: new Date().toLocaleTimeString(), stock: currentStock, type: "ë¡± ë§¤ìˆ˜", price, amount, total: totalCost });
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  // ë¡±ë§¤ë„
  function sellStock() {
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if (isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ ì˜¤ë¥˜");
    const price = stockData[currentStock].slice(-1)[0];
    const held = usersData[currentUserName].stocks[currentStock] || 0;
    if (held < amount) return alert("ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡±");

    usersData[currentUserName].stocks[currentStock] -= amount;
    const gain = price * amount;
    usersData[currentUserName].cash += gain;
    usersData[currentUserName].trades.push({ time: new Date().toLocaleTimeString(), stock: currentStock, type: "ë¡± ë§¤ë„", price, amount, total: gain });
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  // ìˆë§¤ìˆ˜ (ìˆ í¬ì§€ì…˜ ì§„ì…, ì£¼ì‹ ë¹Œë ¤ì„œ íŒ ê²ƒê³¼ ë™ì¼, í˜„ê¸ˆ ì¦ê°€)
  function shortSell() {
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if (isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ ì˜¤ë¥˜");
    const price = stockData[currentStock].slice(-1)[0];
    const totalGain = price * amount;

    usersData[currentUserName].cash += totalGain;
    usersData[currentUserName].shortStocks[currentStock] = (usersData[currentUserName].shortStocks[currentStock] || 0) + amount;
    usersData[currentUserName].trades.push({ time: new Date().toLocaleTimeString(), stock: currentStock, type: "ìˆ ë§¤ìˆ˜ (ìˆ ì§„ì…)", price, amount, total: totalGain });
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  // ìˆë§¤ë„ (ìˆ í¬ì§€ì…˜ ì²­ì‚°, ì£¼ì‹ ì‚¬ì„œ ë¹Œë¦° ì£¼ì‹ ê°šìŒ, í˜„ê¸ˆ ê°ì†Œ)
  function shortBuy() {
    const amount = parseInt(document.getElementById('tradeAmount').value);
    if (isNaN(amount) || amount <= 0) return alert("ìˆ˜ëŸ‰ ì˜¤ë¥˜");
    const price = stockData[currentStock].slice(-1)[0];
    const heldShort = usersData[currentUserName].shortStocks[currentStock] || 0;
    if (heldShort < amount) return alert("ìˆ í¬ì§€ì…˜ ë¶€ì¡±");

    const totalCost = price * amount;
    if (usersData[currentUserName].cash < totalCost) return alert("ìê¸ˆ ë¶€ì¡±");

    usersData[currentUserName].cash -= totalCost;
    usersData[currentUserName].shortStocks[currentStock] -= amount;
    usersData[currentUserName].trades.push({ time: new Date().toLocaleTimeString(), stock: currentStock, type: "ìˆ ë§¤ë„ (ìˆ ì²­ì‚°)", price, amount, total: totalCost });
    saveUsersData();
    updateInfo();
    updateTradeLog();
  }

  function updateTradeLog() {
    const logBody = document.getElementById('tradeLog').querySelector('tbody');
    logBody.innerHTML = "";
    usersData[currentUserName].trades.slice().reverse().forEach(trade => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${trade.time}</td>
        <td>${trade.stock}</td>
        <td>${trade.type}</td>
        <td>${trade.price.toLocaleString()}</td>
        <td>${trade.amount}</td>
        <td>${trade.total.toLocaleString()}</td>
      `;
      logBody.appendChild(row);
    });
  }

  function updateInfo() {
    document.getElementById('cash').textContent = usersData[currentUserName].cash.toLocaleString();
    const price = stockData[currentStock].slice(-1)[0];
    const shares = usersData[currentUserName].stocks[currentStock] || 0;
    const shortShares = usersData[currentUserName].shortStocks[currentStock] || 0;
    document.getElementById('shares').textContent = shares;
    document.getElementById('shortShares').textContent = shortShares;
    document.getElementById('currentPrice').textContent =
