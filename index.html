<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>주식 시뮬레이터</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; display: flex; gap: 30px; padding: 20px; }
    .left, .right { flex: 1; }
    canvas { max-width: 100%; height: 200px; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px 8px; }
    .chart-container { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="left">
    <h2>주식 시뮬레이터</h2>
    <p>이름: <input id="username" placeholder="이름 입력" /></p>
    <p>자금: <span id="money">-</span>원</p>
    <p>총 자산: <span id="net">-</span>원</p>
    <div id="stocks"></div>
    <h3>거래</h3>
    <select id="tradeStock"></select>
    <input type="number" id="tradeAmount" value="1" min="1" />
    <select id="tradeType">
      <option value="buy">매수 (Long)</option>
      <option value="sell">매도 (Long)</option>
      <option value="short">공매도 (Short)</option>
      <option value="cover">숏 청산 (Short)</option>
    </select>
    <button onclick="trade()">거래 실행</button>
    <h3>수익률 랭킹</h3>
    <table id="ranking"><thead><tr><th>이름</th><th>수익률</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="right" id="charts"></div>

  <script>
    const stockList = [
      "삼성전자", "현대차", "네이버", "카카오", "LG화학",
      "셀트리온", "한화솔루션", "SK하이닉스", "POSCO", "두산에너빌리티",
      "한미약품", "FIRE1000", "BOMB1000", "HOPE1000", "DOGE1000"
    ];
    const prices = {};
    const holdings = {};
    const shorts = {};
    const priceHistories = {};
    const charts = {};

    let money = 100000;
    let username = localStorage.getItem("sim_name") || "";

    if (username) document.getElementById("username").value = username;

    function saveName() {
      username = document.getElementById("username").value;
      localStorage.setItem("sim_name", username);
      saveState();
    }

    document.getElementById("username").addEventListener("change", saveName);

    function init() {
      stockList.forEach(name => {
        prices[name] = name.includes("1000") ? 1000 : Math.floor(Math.random() * 10000 + 10000);
        holdings[name] = 0;
        shorts[name] = 0;
        priceHistories[name] = [prices[name]];
      });

      updateStockUI();
      updateChartUI();
      updateSelect();
      updateDisplay();
    }

    function updateStockUI() {
      const stockDiv = document.getElementById("stocks");
      stockDiv.innerHTML = "<h3>보유 종목</h3>";
      for (const name of stockList) {
        stockDiv.innerHTML += `<p>${name}: <span id="holding-${name}">0</span>주 / 숏: <span id="short-${name}">0</span>주</p>`;
      }
    }

    function updateChartUI() {
      const chartArea = document.getElementById("charts");
      chartArea.innerHTML = "";
      stockList.forEach(name => {
        const container = document.createElement("div");
        container.className = "chart-container";
        const canvas = document.createElement("canvas");
        canvas.id = "chart-" + name;
        container.appendChild(document.createTextNode(name));
        container.appendChild(canvas);
        chartArea.appendChild(container);

        const ctx = canvas.getContext("2d");
        charts[name] = new Chart(ctx, {
          type: "line",
          data: {
            labels: Array(priceHistories[name].length).fill(""),
            datasets: [{
              label: name,
              data: priceHistories[name],
              borderColor: "blue",
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { display: false },
              y: { beginAtZero: false }
            }
          }
        });
      });
    }

    function updateSelect() {
      const sel = document.getElementById("tradeStock");
      stockList.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.innerText = name;
        sel.appendChild(opt);
      });
    }

    function updatePrices() {
      for (const name of stockList) {
        const price = prices[name];
        const change = price * (Math.random() * 0.02 - 0.003); // -0.3% ~ +1.7%
        prices[name] = Math.max(10, Math.floor(price + change));
        priceHistories[name].push(prices[name]);
        if (priceHistories[name].length > 50) priceHistories[name].shift();

        charts[name].data.labels = priceHistories[name].map((_, i) => i);
        charts[name].data.datasets[0].data = priceHistories[name];
        charts[name].update();
      }
      updateDisplay();
    }

    function updateDisplay() {
      for (const name of stockList) {
        document.getElementById("holding-" + name).innerText = holdings[name];
        document.getElementById("short-" + name).innerText = shorts[name];
      }
      document.getElementById("money").innerText = money.toLocaleString();
      document.getElementById("net").innerText = calcNetWorth().toLocaleString();
      updateRanking();
    }

    function calcNetWorth() {
      let total = money;
      for (const name of stockList) {
        total += holdings[name] * prices[name];
        total -= shorts[name] * prices[name];
      }
      return total;
    }

    function trade() {
      const name = document.getElementById("tradeStock").value;
      const amount = parseInt(document.getElementById("tradeAmount").value);
      const type = document.getElementById("tradeType").value;
      const price = prices[name];
      if (amount <= 0 || !username) return alert("이름 설정 및 수량 확인");

      if (type === "buy") {
        const cost = amount * price;
        if (money >= cost) {
          money -= cost;
          holdings[name] += amount;
        }
      } else if (type === "sell") {
        if (holdings[name] >= amount) {
          money += amount * price;
          holdings[name] -= amount;
        }
      } else if (type === "short") {
        money += amount * price;
        shorts[name] += amount;
      } else if (type === "cover") {
        if (shorts[name] >= amount) {
          const cost = amount * price;
          if (money >= cost) {
            money -= cost;
            shorts[name] -= amount;
          }
        }
      }

      saveState();
      updateDisplay();
    }

    function updateRanking() {
      const data = JSON.parse(localStorage.getItem("sim_ranking") || "{}");
      data[username] = calcNetWorth();
      localStorage.setItem("sim_ranking", JSON.stringify(data));

      const tbody = document.querySelector("#ranking tbody");
      tbody.innerHTML = "";
      const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]);
      for (const [name, net] of sorted) {
        const tr = document.createElement("tr");
        const pct = ((net - 100000) / 100000 * 100).toFixed(2);
        tr.innerHTML = `<td>${name}</td><td>${pct}%</td>`;
        tbody.appendChild(tr);
      }
    }

    function saveState() {
      localStorage.setItem("sim_money", money);
      localStorage.setItem("sim_holdings", JSON.stringify(holdings));
      localStorage.setItem("sim_shorts", JSON.stringify(shorts));
    }

    function loadState() {
      money = parseInt(localStorage.getItem("sim_money") || "100000");
      Object.assign(holdings, JSON.parse(localStorage.getItem("sim_holdings") || "{}"));
      Object.assign(shorts, JSON.parse(localStorage.getItem("sim_shorts") || "{}"));
    }

    init();
    loadState();
    updateDisplay();

    setInterval(updatePrices, 2000); // 2초마다 가격 갱신

    setInterval(() => {
      for (const name of stockList) prices[name] *= 0.5; // 100초마다 폭락
    }, 100000);

    setInterval(() => {
      for (const name of stockList) prices[name] *= 2.2; // 150초마다 폭등
    }, 150000);
  </script>
</body>
</html>
